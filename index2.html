<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#fb7185;
      --border:rgba(148,163,184,.18);
      --tap:44px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai","Noto Sans",sans-serif;background:linear-gradient(180deg,#050915 0%,#0b1220 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:380px 1fr}}

    .panel{background:rgba(15,26,48,.7);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .panel .hd{padding:12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .bd{padding:12px}

    input[type="text"]{width:100%;min-height:40px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#081022;color:var(--text);outline:none}
    input[type="text"]::placeholder{color:#64748b}

    .btn{cursor:pointer;border:1px solid var(--border);background:#0a1327;color:var(--text);padding:10px 12px;border-radius:12px;font-weight:700;font-size:13px;min-height:40px}
    .btn:hover{border-color:rgba(148,163,184,.4)}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#04110a}
    .btn.secondary{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}
    .btn.danger{background:linear-gradient(90deg,#e11d48,#fb7185);border:none;color:#18040a}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .list{max-height:62vh;overflow:auto}
    .item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
    .item:hover{background:rgba(96,165,250,.08)}
    .item.active{background:rgba(34,197,94,.12)}
    .idx{color:var(--muted);font-variant-numeric:tabular-nums;min-width:38px}
    .th{font-size:15px;line-height:1.4}
    .zh{font-size:14px;color:#c7d2fe;margin-top:3px}

    .card{padding:14px;border-radius:14px;background:rgba(15,26,48,.7);border:1px solid var(--border)}
    .bigTH{font-size:22px;font-weight:900;letter-spacing:.2px}
    .bigZH{margin-top:10px;font-size:20px;font-weight:900}
    .bigPY{margin-top:6px;color:var(--accent2);font-size:15px}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}

    .progress{height:10px;background:#071022;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#16a34a,#22c55e);width:0%}

    .toggle{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .toggle input{transform:scale(1.1)}

    .note{color:var(--muted);font-size:12px;line-height:1.55}
    code{background:#071022;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
    .warn{color:#fbbf24}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(8,16,34,.6);color:var(--muted);font-size:12px}

    /* MCQ */
    .choices{display:flex;flex-direction:column;gap:10px}
    .choiceBtn{width:100%;text-align:left;min-height:44px;white-space:normal;line-height:1.25}

    /* Mobile tabs */
    .mobile-nav{
      display:none;
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      background:rgba(11,18,32,.92);
      backdrop-filter:blur(10px);
      border-top:1px solid var(--border);
      z-index:60;
      gap:10px;
    }
    .seg{flex:1;display:flex;gap:8px}
    .seg button{flex:1;min-height:44px}
    .seg .active{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}

    @media(max-width:699px){
      .wrap{padding:6px}
      header .wrap{padding:6px 6px}
      h1{font-size:15px;line-height:1.2}
      .pill{font-size:10px;padding:4px 7px}

      .grid{gap:6px}
      .panel{border-radius:10px}
      .panel .hd{padding:6px;gap:4px}
      .panel .bd{padding:6px}

      .btn{min-height:32px;padding:6px 8px;font-size:12px;border-radius:10px}
      .btn.primary, .btn.secondary, .btn.danger{font-size:12px;padding:6px 8px}
      input[type="text"]{min-height:32px;padding:6px 8px;font-size:13px;border-radius:10px}

      main.wrap{padding-bottom:calc(60px + env(safe-area-inset-bottom))}
      .list{max-height:none;height:calc(100dvh - 200px);border-radius:10px}
      #cardPanel .bd{max-height:calc(100dvh - 160px);overflow:auto;-webkit-overflow-scrolling:touch}

      .row{gap:4px}
      .row > *{flex:1 1 48%}
      .row .tight{flex:1 1 auto}

      .mobile-nav{display:flex;padding:6px 6px 10px 6px}
      .seg button{min-height:32px;font-size:13px}

      .card{padding:8px;border-radius:10px}
      .bigTH{font-size:17px}
      .bigZH{font-size:15px}
      .bigPY{font-size:12px}
      .meta{font-size:10px;gap:4px}
      .note{font-size:11px}
      .choices{gap:6px}
      .choiceBtn{min-height:32px;font-size:13px;padding:6px 8px;border-radius:8px}
      .progress{height:7px}
      .bar{height:100%}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <h1>
        ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰
        <br><span style="font-size:13px;color:#94a3b8">à¸šà¸—à¹€à¸£à¸µà¸¢à¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™ 100 à¸›à¸£à¸°à¹‚à¸¢à¸„ (à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡)</span>
      </h1>
      <span class="pill">æ™®é€šï¼šç‚¹åˆ—è¡¨æ’­ä¸­æ–‡ï½œæµ‹éªŒï¼šé¢˜ç›®=æ³°è¯­+æ³°è¯­éŸ³é¢‘ï¼›ç­”æ¡ˆ=ä¸­æ–‡+æ‹¼éŸ³ï¼ˆå››é€‰ä¸€ï¼‰</span>
      <span class="pill" id="status">æœªåŠ è½½</span>
      <span class="pill" id="csvWhere">CSVï¼š/lesson100/phrases.csv</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- List panel -->
    <section class="panel" id="listPanel">
      <div class="hd">
        <input id="q" type="text" placeholder="æœç´¢ï¼šæ³°è¯­ / ä¸­æ–‡ / æ‹¼éŸ³ / key â€¦" />
        <button class="btn tight" id="clear">æ¸…ç©º</button>
      </div>

      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <button class="btn" id="quiz">ğŸ§ å¬éŸ³é—®ç­”<br>à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸šà¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</button>
          <button class="btn secondary" id="shuffle">éšæœº</button>
          <button class="btn" id="prev">ä¸Šä¸€æ¡</button>
          <button class="btn" id="next">ä¸‹ä¸€æ¡</button>
        </div>

        <div class="progress" title="å­¦ä¹ è¿›åº¦ï¼ˆå·²æ ‡è®°ç†Ÿæ‚‰ï¼‰"><div class="bar" id="bar"></div></div>

        <div class="meta" style="margin:10px 0 0">
          <span id="count">0 æ¡</span>
          <span id="knownCount">å·²ç†Ÿæ‚‰ 0</span>
          <span class="toggle"><input type="checkbox" id="auto"> è‡ªåŠ¨ä¸‹ä¸€æ¡</span>
          <span class="toggle"><input type="checkbox" id="loop"> å¾ªç¯æ’­æ”¾</span>
          <span class="badge" id="mode">æ™®é€šæ¨¡å¼</span>
        </div>
      </div>

      <div class="list" id="list"></div>
    </section>

    <!-- Card panel -->
    <section class="panel" id="cardPanel">
      <div class="hd">
        <button class="btn primary" id="playTh">â–¶ æ’­æ”¾æ³°è¯­<br>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</button>
        <button class="btn" id="replay">âŸ² é‡æ’­</button>
        <button class="btn secondary" id="showAns">ğŸ‘ æ˜¾ç¤ºç­”æ¡ˆ<br>à¸”à¸¹à¸„à¸³à¸•à¸­à¸š</button>
        <button class="btn secondary" id="mcqMode">ğŸ…°ğŸ…± é€‰æ‹©é¢˜<br>à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸</button>
        <button class="btn" id="playZh">â–¶ æ’­æ”¾ä¸­æ–‡<br>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™</button>
        <button class="btn" id="prevQ">â—€ ä¸Šä¸€é¢˜<br>à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²</button>
        <button class="btn" id="nextQ">ä¸‹ä¸€é¢˜ â–¶<br>à¸–à¸±à¸”à¹„à¸›</button>
        <button class="btn" id="mark">âœ“ æ ‡è®°ç†Ÿæ‚‰</button>
        <button class="btn danger" id="reset">é‡ç½®ç†Ÿæ‚‰</button>
      </div>

      <div class="bd">
        <div class="card">
          <div class="bigTH" id="bigTH">â€”</div>
          <div class="bigZH" id="bigZH">â€”</div>
          <div class="bigPY" id="bigPY">â€”</div>
          <div class="meta">
            <span>éŸ³é¢‘ keyï¼š<code id="key">â€”</code></span>
            <span>æ–‡ä»¶ï¼š<code id="file">â€”</code></span>
            <span>é”™é¢˜ï¼š<code id="wrongStat">0é¢˜/0æ¬¡</code></span>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card" id="mcq" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div style="font-weight:900">é€‰æ‹©é¢˜ï¼ˆå››é€‰ä¸€ï¼‰<span style="font-weight:700;color:#94a3b8">ï½œà¸„à¸³à¸–à¸²à¸¡à¹à¸šà¸šà¹€à¸¥à¸·à¸­à¸à¸•à¸­à¸š</span></div>
            <div class="row" style="margin:0">
              <button class="btn tight" id="wrongOnlyBtn">åªç»ƒé”™é¢˜ï¼šå…³</button>
              <button class="btn danger tight" id="clearWrong">æ¸…ç©ºé”™é¢˜</button>
            </div>
          </div>
          <div style="height:10px"></div>
          <div id="choices" class="choices"></div>
          <div style="height:10px"></div>
          <div class="note" id="mcqHint">ç‚¹å‡»é€‰é¡¹ä½œç­”ã€‚ç­”å®Œä¼šæ˜¾ç¤ºæ­£è¯¯ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚</div>
        </div>

        <div style="height:12px"></div>

        <div class="note">
          <b>æ–‡ä»¶ç»“æ„ï¼ˆåŒä¸€æ–‡ä»¶å¤¹ï¼‰</b><br>
          <code>index2.html</code>ï¼ˆæœ¬æ–‡ä»¶ï¼‰<br>
          <code>phrases.csv</code>ï¼ˆ3åˆ—ï¼šThai,Chinese_Pinyin,TTS_Keyï¼‰<br>
          <code>audio/</code>ï¼ˆä¸­æ–‡éŸ³é¢‘ï¼‰<code>&lt;key&gt;.mp3</code>ï¼ˆä¾‹ <code>audio/zh_cn_0001.mp3</code>ï¼‰<br>
          <code>audio_th/</code>ï¼ˆæ³°è¯­éŸ³é¢‘ï¼‰<code>th_0001.mp3</code>ï¼ˆä¾‹ <code>audio_th/th_0001.mp3</code>ï¼‰<br>
          <br>
          <span class="warn"><b>æç¤ºï¼š</b></span>CSV å›ºå®šä» <code>/lesson100/phrases.csv</code> åŠ è½½ï¼›è¯·ç”¨ GitHub Pages æ‰“å¼€ï¼ˆä¸è¦ file:// / Drive é¢„è§ˆï¼‰ã€‚
        </div>
      </div>
    </section>

  </div>

  <div class="mobile-nav" id="mobileNav">
    <div class="seg">
      <button class="btn" id="tabList">ğŸ“‹ åˆ—è¡¨<br>à¸£à¸²à¸¢à¸à¸²à¸£</button>
      <button class="btn active" id="tabPractice">ğŸ§ ç»ƒä¹ <br>à¸à¸¶à¸</button>
    </div>
  </div>
</main>

<audio id="audio" preload="auto"></audio>

<script>
(function(){
  "use strict";

  function el(id){ return document.getElementById(id); }

  var listEl = el("list");
  var qEl = el("q");
  var statusEl = el("status");
  var modeEl = el("mode");

  var bigTH = el("bigTH");
  var bigZH = el("bigZH");
  var bigPY = el("bigPY");
  var keyEl = el("key");
  var fileEl = el("file");

  var barEl = el("bar");
  var countEl = el("count");
  var knownCountEl = el("knownCount");

  var wrongStatEl = el("wrongStat");
  var mcqCard = el("mcq");
  var choicesEl = el("choices");
  var mcqHintEl = el("mcqHint");

  var csvWhereEl = el("csvWhere");

  var audio = el("audio");
  var autoNext = el("auto");
  var loopPlay = el("loop");

  // ------------------------------
  // State
  // ------------------------------
  var DATA = [];
  var VIEW = [];
  var activeIdx = 0;

  var quizMode = false;
  var quizIdx = 0;

  var mcqEnabled = true; // default ON
  var answered = false;
  var currentChoices = null; // { correctKey, options }

  var wrongOnly = false;

  var KNOWN_KEY = "lesson100_known_v1";
  var WRONG_KEY = "lesson100_wrong_v1";

  var known = new Set(JSON.parse(localStorage.getItem(KNOWN_KEY) || "[]"));
  var wrongMap = JSON.parse(localStorage.getItem(WRONG_KEY) || "{}") || {};

  function saveKnown(){ localStorage.setItem(KNOWN_KEY, JSON.stringify(Array.from(known))); }
  function saveWrong(){ localStorage.setItem(WRONG_KEY, JSON.stringify(wrongMap)); updateWrongStat(); }

  function updateWrongStat(){
    var keys = Object.keys(wrongMap);
    var total = 0;
    for (var i=0;i<keys.length;i++) total += Number(wrongMap[keys[i]] || 0);
    wrongStatEl.textContent = keys.length + "é¢˜/" + total + "æ¬¡";
  }

  function getQuizPool(){
    if (!wrongOnly) {
      var all = [];
      for (var i=0;i<VIEW.length;i++) all.push(i);
      return all;
    }
    var keys = new Set(Object.keys(wrongMap));
    var idxs = [];
    for (var j=0;j<VIEW.length;j++) {
      if (keys.has(VIEW[j][2])) idxs.push(j);
    }
    if (idxs.length) return idxs;
    var fallback = [];
    for (var k=0;k<VIEW.length;k++) fallback.push(k);
    return fallback;
  }

  function currentKey(){
    var idx = quizMode ? quizIdx : activeIdx;
    return (VIEW[idx] || [])[2] || "";
  }

  // ------------------------------
  // Mobile tabs
  // ------------------------------
  function applyMobileTabs(){
    var isMobile = window.matchMedia("(max-width:699px)").matches;
    var listPanel = el("listPanel");
    var cardPanel = el("cardPanel");
    var nav = el("mobileNav");
    if (!listPanel || !cardPanel || !nav) return;

    if (!isMobile) {
      nav.style.display = "none";
      listPanel.style.display = "";
      cardPanel.style.display = "";
      return;
    }

    if (!window.__tab) window.__tab = "practice";
    nav.style.display = "flex";
    listPanel.style.display = (window.__tab === "list") ? "" : "none";
    cardPanel.style.display = (window.__tab === "practice") ? "" : "none";

    el("tabList").classList.toggle("active", window.__tab === "list");
    el("tabPractice").classList.toggle("active", window.__tab === "practice");
  }

  window.addEventListener("resize", applyMobileTabs);

  document.addEventListener("click", function(e){
    var t = e && e.target;
    if (!t) return;
    if (t.id === "tabList") { window.__tab = "list"; applyMobileTabs(); }
    if (t.id === "tabPractice") { window.__tab = "practice"; applyMobileTabs(); }
  });

  // ------------------------------
  // CSV
  // ------------------------------
  function parseCSV(text){
    // Simple RFC4180-ish parser for comma + double quotes
    var rows = [];
    var row = [];
    var cur = "";
    var inQ = false;

    for (var i = 0; i < text.length; i++) {
      var ch = text[i];

      if (ch === '"') {
        if (inQ && text[i + 1] === '"') {
          cur += '"';
          i++;
        } else {
          inQ = !inQ;
        }
        continue;
      }

      if (!inQ && ch === ',') {
        row.push(cur.trim());
        cur = "";
        continue;
      }

      if (!inQ && (ch === '\n' || ch === '\r')) {
        if (ch === '\r' && text[i + 1] === '\n') i++; // handle CRLF
        row.push(cur.trim());
        cur = "";
        if (row.some(function (x) { return x !== ""; })) rows.push(row);
        row = [];
        continue;
      }

      cur += ch;
    }

    row.push(cur.trim());
    if (row.some(function (x) { return x !== ""; })) rows.push(row);
    return rows;
  }

  function loadCSV(){
    // Locked to your GitHub Pages structure
    var url = "/lesson100/phrases.csv";

    return fetch(url, { cache: "no-store" })
      .then(function(res){
        if (!res.ok) throw new Error("HTTP " + res.status + " " + res.statusText + " | " + url);
        return res.text();
      })
      .then(function(text){
        console.log("CSV content:", text); // Debug: Log raw CSV content
        var rows = parseCSV(text);
        console.log("Parsed rows:", rows); // Debug: Log parsed rows

        // header optional
        var head = (rows[0] || []).map(function(x){ return String(x || "").toLowerCase(); });
        var hasHeader = head.indexOf("thai") !== -1 || head.indexOf("chinese_pinyin") !== -1 || head.indexOf("tts_key") !== -1;
        if (hasHeader) rows = rows.slice(1);

        var out = [];
        for (var i=0;i<rows.length;i++) {
          var r = rows[i];
          var thai = String(r[0] || "").trim();
          var zhpy = String(r[1] || "").trim();
          var key  = String(r[2] || "").trim();
          if (!thai || !zhpy || !key) continue;
          out.push([thai, zhpy, key]);
        }

        if (!out.length) throw new Error("CSV downloaded but empty after parse. Expect 3 cols: Thai,Chinese_Pinyin,TTS_Key");
        if (csvWhereEl) csvWhereEl.textContent = "CSVï¼š" + url;
        console.log("Final output:", out); // Debug: Log final output
        return out;
      })
      .catch(function(e){
        console.error("Error loading CSV:", e); // Debug: Log error details
        var msg = "æ— æ³•åŠ è½½CSVã€‚" +
          "Request URL: " + url + "" +
          "é”™è¯¯ï¼š" + (e && e.message ? e.message : String(e)) + "" +
          "æ£€æŸ¥ï¼š1) phrases.csv æ˜¯å¦åœ¨ä»“åº“æ ¹ç›®å½•ä¸”å¤§å°å†™ä¸€è‡´ 2) Pages å‘å¸ƒæº main/root 3) ä¸è¦ file:// / Drive é¢„è§ˆ";
        throw new Error(msg);
      });
  }

  function splitZhPy(zhpy){
    var s = String(zhpy || "").trim();
    var p = s.lastIndexOf(" ");
    if (p <= 0) return { zh: s, py: "" };
    var zh = s.slice(0, p).trim();
    var py = s.slice(p + 1).trim();
    if (py.length < 2) return { zh: s, py: "" };
    return { zh: zh, py: py };
  }

  function zhAudioPath(key){ return "audio/" + key + ".mp3"; }
  function thAudioPath(key){
    // key like zh_cn_0014 => th_0014.mp3
    var parts = String(key).split("_");
    var num = parts[parts.length - 1] || "0001";
    num = String(num).padStart(4, "0");
    return "audio_th/th_" + num + ".mp3";
  }

  function shuffle(arr){
    for (var i=arr.length-1;i>0;i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var t = arr[i];
      arr[i] = arr[j];
      arr[j] = t;
    }
    return arr;
  }

  // ------------------------------
  // UI
  // ------------------------------
  function updateModeUI(){
    modeEl.textContent = quizMode ? "æµ‹éªŒæ¨¡å¼" : "æ™®é€šæ¨¡å¼";

    el("showAns").style.display = quizMode ? "inline-block" : "none";
    el("mcqMode").style.display = quizMode ? "inline-block" : "none";
    el("playTh").style.display = quizMode ? "inline-block" : "none";
    el("playZh").style.display = quizMode ? "inline-block" : "none";

    mcqCard.style.display = (quizMode && mcqEnabled) ? "block" : "none";
  }

  function updateProgress(){
    var total = VIEW.length || 1;
    var kc = 0;
    for (var i=0;i<VIEW.length;i++) if (known.has(VIEW[i][2])) kc++;
    knownCountEl.textContent = "å·²ç†Ÿæ‚‰ " + kc;
    barEl.style.width = Math.round((kc / total) * 100) + "%";
    updateWrongStat();
  }

  function renderList(){
    listEl.innerHTML = "";

    for (var i=0;i<VIEW.length;i++) {
      (function(i){
        var thai = VIEW[i][0];
        var zhpy = VIEW[i][1];
        var key = VIEW[i][2];

        var div = document.createElement("div");
        var isActive = quizMode ? (i === quizIdx) : (i === activeIdx);
        div.className = "item" + (isActive ? " active" : "");

        var idx = document.createElement("div");
        idx.className = "idx";
        idx.textContent = String(i + 1).padStart(3, "0");

        var body = document.createElement("div");
        var th = document.createElement("div");
        th.className = "th";

        var wrongTag = wrongMap[key] ? ("  âœ—" + wrongMap[key]) : "";
        th.textContent = thai + (known.has(key) ? "  âœ“" : "") + wrongTag;

        var zh = document.createElement("div");
        zh.className = "zh";
        zh.textContent = zhpy;

        body.appendChild(th);
        body.appendChild(zh);

        div.appendChild(idx);
        div.appendChild(body);

        div.addEventListener("click", function(){
          if (quizMode) {
            quizIdx = i;
            answered = false;
            currentChoices = null;
            renderList();
            renderQuizCard();
            if (mcqEnabled) buildChoices();
            playThai();
          } else {
            activeIdx = i;
            renderList();
            renderStudyCard();
            playChinese();
          }

          if (window.matchMedia("(max-width:699px)").matches) {
            window.__tab = "practice";
            applyMobileTabs();
          }
        });

        listEl.appendChild(div);
      })(i);
    }

    countEl.textContent = VIEW.length + " æ¡";
    updateProgress();
  }

  function renderStudyCard(){
    if (!VIEW.length) return;
    var it = VIEW[activeIdx] || VIEW[0];
    var thai = it[0];
    var zhpy = it[1];
    var key = it[2];

    var sp = splitZhPy(zhpy);

    bigTH.textContent = thai;
    bigZH.textContent = sp.zh || "â€”";
    bigPY.textContent = sp.py || "";

    keyEl.textContent = key;
    fileEl.textContent = "ZH: " + zhAudioPath(key);
  }

  function renderQuizCard(){
    if (!VIEW.length) return;
    var it = VIEW[quizIdx] || VIEW[0];
    var thai = it[0];
    var zhpy = it[1];
    var key = it[2];

    var sp = splitZhPy(zhpy);

    bigTH.textContent = "Q" + String(quizIdx + 1).padStart(3, "0") + ". " + thai;
    keyEl.textContent = key;
    fileEl.textContent = "TH: " + thAudioPath(key) + " | ZH: " + zhAudioPath(key);

    if (mcqEnabled) {
      if (answered) {
        bigZH.textContent = sp.zh || "â€”";
        bigPY.textContent = sp.py || "";
      } else {
        bigZH.textContent = "ï¼ˆå››é€‰ä¸€ï¼šè¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆï¼‰";
        bigPY.textContent = "";
      }
    } else {
      bigZH.textContent = "ï¼ˆç‚¹å‡»â€œæ˜¾ç¤ºç­”æ¡ˆâ€ï¼‰";
      bigPY.textContent = "";
    }
  }

  // ------------------------------
  // MCQ
  // ------------------------------
  function buildChoices(){
    var it = VIEW[quizIdx];
    if (!it) return;

    var key = it[2];
    var sp0 = splitZhPy(it[1]);

    var options = [{ key: key, zh: sp0.zh, py: sp0.py }];
    var pool = [];
    for (var i=0;i<VIEW.length;i++) if (VIEW[i][2] !== key) pool.push(VIEW[i]);

    var need = Math.min(3, pool.length);
    var used = new Set([key]);

    while (options.length < 1 + need) {
      var pick = pool[Math.floor(Math.random() * pool.length)];
      var pKey = pick[2];
      if (used.has(pKey)) continue;
      used.add(pKey);
      var sp = splitZhPy(pick[1]);
      options.push({ key: pKey, zh: sp.zh, py: sp.py });
    }

    shuffle(options);
    currentChoices = { correctKey: key, options: options };
    answered = false;
    mcqHintEl.textContent = "ç‚¹å‡»é€‰é¡¹ä½œç­”ã€‚ç­”å®Œä¼šæ˜¾ç¤ºæ­£è¯¯ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚";
    renderChoicesUI();
  }

  function renderChoicesUI(){
    choicesEl.innerHTML = "";
    if (!quizMode || !mcqEnabled || !currentChoices) return;

    var letters = ["A","B","C","D"];
    for (var i=0;i<currentChoices.options.length;i++) {
      (function(i){
        var opt = currentChoices.options[i];
        var btn = document.createElement("button");
        btn.className = "btn choiceBtn";
        btn.textContent = letters[i] + ". " + opt.zh + (opt.py ? ("  (" + opt.py + ")") : "");

        if (answered && opt.key === currentChoices.correctKey) {
          btn.className = "btn primary choiceBtn";
        }

        btn.addEventListener("click", function(){
          if (answered) return;
          answered = true;

          var correctKey = currentChoices.correctKey;
          if (opt.key === correctKey) {
            mcqHintEl.textContent = "âœ… æ­£ç¡®ï¼";
          } else {
            mcqHintEl.textContent = "âŒ é”™äº†ï¼šå·²åŠ å…¥é”™é¢˜ã€‚";
            wrongMap[correctKey] = Number(wrongMap[correctKey] || 0) + 1;
            saveWrong();
          }

          renderQuizCard();
          renderChoicesUI();

          if (autoNext.checked) {
            setTimeout(function(){
              nextQuestion();
              playThai();
            }, 600);
          }
        });

        choicesEl.appendChild(btn);
      })(i);
    }
  }

  // ------------------------------
  // Audio
  // ------------------------------
  function safePlay(src){
    audio.loop = !!(loopPlay && loopPlay.checked);
    audio.src = src;
    return audio.play().catch(function(){
      alert(
        "æ— æ³•æ’­æ”¾éŸ³é¢‘ï¼š" + src + "" +
        "è¯·æ£€æŸ¥ï¼š" +
        "1) ä¸­æ–‡éŸ³é¢‘ï¼šaudio/<key>.mp3 æ˜¯å¦å­˜åœ¨" +
        "2) æ³°è¯­éŸ³é¢‘ï¼šaudio_th/th_XXXX.mp3 æ˜¯å¦å­˜åœ¨" +
        "3) æ‰‹æœºæµè§ˆå™¨éœ€å…ˆæ‰‹åŠ¨ç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”æƒé™" +
        "4) å»ºè®®ç”¨ GitHub Pages æ‰“å¼€ï¼ˆä¸è¦ Drive é¢„è§ˆï¼‰"
      );
    });
  }

  function playThai(){
    var key = currentKey();
    if (!key) return;
    safePlay(thAudioPath(key));
  }

  function playChinese(){
    var key = currentKey();
    if (!key) return;
    safePlay(zhAudioPath(key));
  }

  // ------------------------------
  // Navigation
  // ------------------------------
  function nextQuestion(){
    if (!VIEW.length) return;
    var pool = getQuizPool();
    var pos = pool.indexOf(quizIdx);
    quizIdx = pool[(pos + 1) % pool.length];
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  }

  function prevQuestion(){
    if (!VIEW.length) return;
    var pool = getQuizPool();
    var pos = pool.indexOf(quizIdx);
    quizIdx = pool[(pos - 1 + pool.length) % pool.length];
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  }

  function nextStudy(){
    if (!VIEW.length) return;
    activeIdx = (activeIdx + 1) % VIEW.length;
    renderList();
    renderStudyCard();
  }

  function prevStudy(){
    if (!VIEW.length) return;
    activeIdx = (activeIdx - 1 + VIEW.length) % VIEW.length;
    renderList();
    renderStudyCard();
  }

  function applyFilter(){
    var q = String(qEl.value || "").trim().toLowerCase();
    if (!q) {
      VIEW = DATA.slice();
    } else {
      VIEW = DATA.filter(function(it){
        return String(it[0]).toLowerCase().includes(q) ||
               String(it[1]).toLowerCase().includes(q) ||
               String(it[2]).toLowerCase().includes(q);
      });
    }

    activeIdx = 0;
    quizIdx = 0;
    answered = false;
    currentChoices = null;

    renderList();
    if (quizMode) {
      renderQuizCard();
      if (mcqEnabled) buildChoices();
    } else {
      renderStudyCard();
    }
  }

  function markKnown(){
    var key = currentKey();
    if (!key) return;
    if (known.has(key)) known.delete(key);
    else known.add(key);
    saveKnown();
    renderList();
    updateProgress();
  }

  function resetKnown(){
    if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰â€˜å·²ç†Ÿæ‚‰â€™æ ‡è®°å—ï¼Ÿ")) return;
    known.clear();
    saveKnown();
    renderList();
    updateProgress();
  }

  function clearWrong(){
    if (!confirm("ç¡®å®šè¦æ¸…ç©ºé”™é¢˜è®°å½•å—ï¼Ÿ")) return;
    var ks = Object.keys(wrongMap);
    for (var i=0;i<ks.length;i++) delete wrongMap[ks[i]];
    saveWrong();
    renderList();
    if (quizMode && mcqEnabled) buildChoices();
  }

  // ------------------------------
  // Events
  // ------------------------------
  el("clear").addEventListener("click", function(){ qEl.value = ""; applyFilter(); });
  qEl.addEventListener("input", applyFilter);

  el("shuffle").addEventListener("click", function(){
    if (quizMode) return;
    VIEW = VIEW.slice().sort(function(){ return Math.random() - 0.5; });
    activeIdx = 0;
    renderList();
    renderStudyCard();
  });

  function onPrev(){
    if (quizMode) { prevQuestion(); playThai(); }
    else { prevStudy(); playChinese(); }
  }
  function onNext(){
    if (quizMode) { nextQuestion(); playThai(); }
    else { nextStudy(); playChinese(); }
  }

  el("prev").addEventListener("click", onPrev);
  el("next").addEventListener("click", onNext);
  el("prevQ").addEventListener("click", onPrev);
  el("nextQ").addEventListener("click", onNext);

  el("replay").addEventListener("click", function(){
    if (quizMode) playThai();
    else playChinese();
  });

  el("playTh").addEventListener("click", function(){
    if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
    playThai();
  });

  el("playZh").addEventListener("click", function(){
    if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
    playChinese();
  });

  el("showAns").addEventListener("click", function(){
    if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
    if (mcqEnabled) {
      return alert("é€‰æ‹©é¢˜å·²å¼€å¯ï¼šè¯·ç›´æ¥ä½œç­”ï¼Œç­”å®Œä¼šæ˜¾ç¤ºç­”æ¡ˆã€‚å¦‚éœ€æ‰‹åŠ¨æ˜¾ç¤ºç­”æ¡ˆï¼Œè¯·å…ˆå…³é—­â€˜é€‰æ‹©é¢˜â€™ã€‚");
    }
    var it = VIEW[quizIdx];
    if (!it) return;
    var sp = splitZhPy(it[1]);
    bigZH.textContent = sp.zh || "â€”";
    bigPY.textContent = sp.py || "";
  });

  el("mcqMode").addEventListener("click", function(){
    if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
    mcqEnabled = !mcqEnabled;
    answered = false;
    currentChoices = null;
    updateModeUI();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  });

  el("wrongOnlyBtn").addEventListener("click", function(){
    wrongOnly = !wrongOnly;
    el("wrongOnlyBtn").textContent = "åªç»ƒé”™é¢˜ï¼š" + (wrongOnly ? "å¼€" : "å…³");
    if (quizMode) {
      var pool = getQuizPool();
      quizIdx = pool[0] || 0;
      answered = false;
      currentChoices = null;
      renderList();
      renderQuizCard();
      if (mcqEnabled) buildChoices();
      playThai();
    }
  });

  el("clearWrong").addEventListener("click", clearWrong);
  el("mark").addEventListener("click", markKnown);
  el("reset").addEventListener("click", resetKnown);

  el("quiz").addEventListener("click", function(){
    quizMode = !quizMode;
    answered = false;
    currentChoices = null;
    quizIdx = activeIdx;

    updateModeUI();
    renderList();

    if (quizMode) {
      renderQuizCard();
      if (mcqEnabled) buildChoices();
      playThai();
    } else {
      renderStudyCard();
    }

    if (window.matchMedia("(max-width:699px)").matches) {
      window.__tab = "practice";
      applyMobileTabs();
    }
  });

  audio.addEventListener("ended", function(){
    if (!autoNext.checked) return;
    if (quizMode) {
      nextQuestion();
      playThai();
    } else {
      nextStudy();
      playChinese();
    }
  });

  // ------------------------------
  // Minimal tests
  // ------------------------------
  function assert(cond, msg){ if (!cond) throw new Error("Test failed: " + msg); }
  function runTests(){
    var sample = "Thai,Chinese_Pinyin,TTS_Key\nà¸ªà¸§à¸±à¸ªà¸”à¸µ,ä½ å¥½ nÇ hÇo,zh_cn_0001"; // Adjusted to include newline
    var rows = parseCSV(sample);
    console.log("Test sample rows:", rows); // Debug: Log parsed rows from sample
    assert(rows.length === 2, "parseCSV rows");

    var sp = splitZhPy("ä½ å¥½ nÇ");
    assert(sp.zh === "ä½ å¥½", "split zh");
    assert(thAudioPath("zh_cn_0014").indexOf("th_0014.mp3") !== -1, "thAudioPath mapping");
  }

  // ------------------------------
  // Init
  // ------------------------------
  function init(){
    try {
      runTests();
    } catch (e) {
      console.error(e);
      alert("å†…ç½®æµ‹è¯•å¤±è´¥ï¼š" + (e && e.message ? e.message : String(e)));
      return;
    }

    statusEl.textContent = "åŠ è½½ä¸­â€¦";

    loadCSV()
      .then(function(out){
        DATA = out;
        VIEW = DATA.slice();

        statusEl.textContent = "å·²åŠ è½½ï¼š" + DATA.length + "æ¡";

        updateModeUI();
        renderList();
        renderStudyCard();
        updateWrongStat();
        applyMobileTabs();

        if (window.matchMedia("(max-width:699px)").matches) {
          window.__tab = "practice";
          applyMobileTabs();
        }
      })
      .catch(function(e){
        console.error(e);
        statusEl.textContent = "é”™è¯¯ï¼šæ— æ³•åŠ è½½CSV";
        alert(e && e.message ? e.message : String(e));
      });
  }

  init();
})();
</script>
</body>
</html>
