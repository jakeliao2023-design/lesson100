<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#fb7185;
      --border:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai","Noto Sans",sans-serif;background:linear-gradient(180deg,#050915 0%,#0b1220 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:380px 1fr}}

    .panel{background:rgba(15,26,48,.7);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .panel .hd{padding:12px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .bd{padding:12px}

    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#081022;color:var(--text);outline:none}
    input[type="text"]::placeholder{color:#64748b}

    .btn{cursor:pointer;border:1px solid var(--border);background:#0a1327;color:var(--text);padding:9px 12px;border-radius:10px;font-weight:600;font-size:13px}
    .btn:hover{border-color:rgba(148,163,184,.4)}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#04110a}
    .btn.secondary{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}
    .btn.danger{background:linear-gradient(90deg,#e11d48,#fb7185);border:none;color:#18040a}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .list{max-height:62vh;overflow:auto}
    .item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
    .item:hover{background:rgba(96,165,250,.08)}
    .item.active{background:rgba(34,197,94,.12)}
    .idx{color:var(--muted);font-variant-numeric:tabular-nums;min-width:38px}
    .th{font-size:15px;line-height:1.4}
    .zh{font-size:14px;color:#c7d2fe;margin-top:3px}

    .card{padding:14px;border-radius:14px;background:rgba(15,26,48,.7);border:1px solid var(--border)}
    .bigTH{font-size:22px;font-weight:800;letter-spacing:.2px}
    .bigZH{margin-top:10px;font-size:20px;font-weight:800}
    .bigPY{margin-top:6px;color:var(--accent2);font-size:15px}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}

    .progress{height:10px;background:#071022;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#16a34a,#22c55e);width:0%}

    .toggle{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .toggle input{transform:scale(1.1)}

    .note{color:var(--muted);font-size:12px;line-height:1.5}
    code{background:#071022;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
    .warn{color:#fbbf24}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(8,16,34,.6);color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <h1>
        ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰
        <br/><span style="font-size:13px;color:#94a3b8">à¸šà¸—à¹€à¸£à¸µà¸¢à¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™ 100 à¸›à¸£à¸°à¹‚à¸¢à¸„ (à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡)</span>
      </h1>
      <span class="pill">æ™®é€šæ¨¡å¼ï¼šç‚¹å‡»åˆ—è¡¨æ’­æ”¾ä¸­æ–‡ï½œæµ‹éªŒï¼šé¢˜ç›®æ³°è¯­+æ³°è¯­éŸ³é¢‘ï¼Œç­”æ¡ˆä¸­æ–‡+æ‹¼éŸ³</span>
      <span class="pill" id="status">æœªåŠ è½½</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- å·¦ä¾§ï¼šåˆ—è¡¨ -->
    <section class="panel">
      <div class="hd">
        <input id="q" type="text" placeholder="æœç´¢ï¼šæ³°è¯­ / ä¸­æ–‡ / æ‹¼éŸ³ / key â€¦" />
        <button class="btn tight" id="clear">æ¸…ç©º</button>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <button class="btn" id="quiz">ğŸ§ å¬éŸ³é—®ç­”<br/>à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸šà¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</button>
          <button class="btn secondary" id="shuffle">éšæœº</button>
          <button class="btn" id="prev">ä¸Šä¸€æ¡</button>
          <button class="btn" id="next">ä¸‹ä¸€æ¡</button>
        </div>
        <div class="progress" title="å­¦ä¹ è¿›åº¦ï¼ˆå·²æ ‡è®°ç†Ÿæ‚‰ï¼‰"><div class="bar" id="bar"></div></div>
        <div class="meta" style="margin:10px 0 0">
          <span id="count">0 æ¡</span>
          <span id="knownCount">å·²ç†Ÿæ‚‰ 0</span>
          <span class="toggle"><input type="checkbox" id="auto" /> è‡ªåŠ¨ä¸‹ä¸€æ¡</span>
          <span class="toggle"><input type="checkbox" id="loop" /> å¾ªç¯æ’­æ”¾</span>
          <span class="badge" id="mode">æ™®é€šæ¨¡å¼</span>
        </div>
      </div>
      <div class="list" id="list"></div>
    </section>

    <!-- å³ä¾§ï¼šå¡ç‰‡ -->
    <section class="panel">
      <div class="hd">
        <button class="btn primary" id="playTh">â–¶ æ’­æ”¾æ³°è¯­<br/>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</button>
        <button class="btn" id="replay">âŸ² é‡æ’­</button>
        <button class="btn secondary" id="showAns">ğŸ‘ æ˜¾ç¤ºç­”æ¡ˆ<br/>à¸”à¸¹à¸„à¸³à¸•à¸­à¸š</button>
        <button class="btn" id="playZh">â–¶ æ’­æ”¾ä¸­æ–‡<br/>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™</button>
        <button class="btn" id="mark">âœ“ æ ‡è®°ç†Ÿæ‚‰</button>
        <button class="btn danger" id="reset">é‡ç½®ç†Ÿæ‚‰</button>
      </div>
      <div class="bd">
        <div class="card">
          <div class="bigTH" id="bigTH">â€”</div>
          <div class="bigZH" id="bigZH">â€”</div>
          <div class="bigPY" id="bigPY">â€”</div>
          <div class="meta">
            <span>éŸ³é¢‘ keyï¼š<code id="key">â€”</code></span>
            <span>æ–‡ä»¶ï¼š<code id="file">â€”</code></span>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="note">
          <b>æ–‡ä»¶ç»“æ„ï¼ˆåŒä¸€æ–‡ä»¶å¤¹ï¼‰:</b><br/>
          <code>index.html</code>ï¼ˆæœ¬æ–‡ä»¶ï¼‰<br/>
          <code>phrases.csv</code>ï¼ˆ3åˆ—ï¼šThai,Chinese_Pinyin,TTS_Keyï¼‰<br/>
          <code>audio/</code>ï¼ˆä¸­æ–‡éŸ³é¢‘ / à¹€à¸ªà¸µà¸¢à¸‡à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™ï¼‰<code>&lt;key&gt;.mp3</code><br/>
          <code>audio_th/</code>ï¼ˆæ³°è¯­éŸ³é¢‘ / à¹€à¸ªà¸µà¸¢à¸‡à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ï¼‰<code>&lt;key&gt;.mp3</code><br/>
          <br/>
          <b class="warn">æ³¨æ„ï¼š</b>æ‰‹æœºæµè§ˆå™¨é€šå¸¸éœ€è¦å…ˆç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘æƒé™ã€‚
        </div>
      </div>
    </section>

  </div>
</main>

<audio id="audio" preload="auto"></audio>

<script>
  "use strict";

  const el = (id) => document.getElementById(id);
  const listEl = el("list");
  const qEl = el("q");
  const statusEl = el("status");
  const modeEl = el("mode");

  const bigTH = el("bigTH");
  const bigZH = el("bigZH");
  const bigPY = el("bigPY");
  const keyEl = el("key");
  const fileEl = el("file");
  const barEl = el("bar");
  const countEl = el("count");
  const knownCountEl = el("knownCount");

  const audio = el("audio");
  const autoNext = el("auto");
  const loopPlay = el("loop");

  let DATA = [];
  let VIEW = [];
  let activeIdx = 0;

  // æµ‹éªŒæ¨¡å¼ï¼šæŒ‰ CSV é¡ºåºå‡ºé¢˜ï¼›é¢˜ç›®=æ³°è¯­+æ³°è¯­éŸ³é¢‘ï¼›ç­”æ¡ˆ=ä¸­æ–‡+æ‹¼éŸ³ + æ’­æ”¾ä¸­æ–‡æŒ‰é’®
  let quizMode = false;
  let quizIdx = 0;
  let quizReveal = false;

  const KNOWN_KEY = "lesson100_known_v1";
  const known = new Set(JSON.parse(localStorage.getItem(KNOWN_KEY) || "[]"));

  function parseCSV(csv) {
    const lines = csv.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
    const rows = [];
    for (const line of lines) {
      if (!line.trim()) continue;
      const row = [];
      let cur = "";
      let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === ',' && !inQ) {
          row.push(cur);
          cur = "";
        } else {
          cur += ch;
        }
      }
      row.push(cur);
      rows.push(row.map(s => (s || "").trim()));
    }
    return rows;
  }

  async function loadCSV() {
    const res = await fetch("phrases.csv", { cache: "no-store" });
    if (!res.ok) throw new Error("phrases.csv not found");
    const text = await res.text();
    let rows = parseCSV(text);

    // è·³è¿‡è¡¨å¤´
    const head = (rows[0] || []).map(x => (x || "").toLowerCase());
    const hasHeader = head.includes("thai") || head.includes("chinese_pinyin") || head.includes("tts_key");
    if (hasHeader) rows = rows.slice(1);

    const out = [];
    for (const r of rows) {
      const thai = (r[0] || "").trim();
      const zhpy = (r[1] || "").trim();
      const key = (r[2] || "").trim();
      if (!thai || !zhpy || !key) continue;
      out.push([thai, zhpy, key]);
    }
    return out;
  }

  function splitZhPy(zhpy) {
    // æœŸæœ›æ ¼å¼ï¼š"ä¸­æ–‡ æ‹¼éŸ³"
    const m = zhpy.match(/^(.*?)(\s+[A-Za-zÄÃ¡ÇÃ Ä“Ã©Ä›Ã¨Ä«Ã­ÇÃ¬ÅÃ³Ç’Ã²Å«ÃºÇ”Ã¹Ç–Ç˜ÇšÇœ\s]+.*)$/);
    if (!m) return { zh: zhpy, py: "" };
    return { zh: m[1].trim(), py: m[2].trim() };
  }

  function zhAudioPath(key) {
    return `audio/${key}.mp3`;
  }
  function thAudioPath(key) {
    // æ³°è¯­éŸ³é¢‘å‘½åè§„åˆ™ï¼šth_0001.mp3ï¼Œä¸ CSV é¡ºåºä¸€è‡´
    // ä» key ä¸­å–åºå·ï¼ˆå¦‚ zh_cn_0001 -> 0001ï¼‰
    const m = key.match(/(\d+)$/);
    const num = m ? m[1].padStart(4, "0") : "0001";
    return "audio_th/th_" + num + ".mp3";
  }.mp3`;
  }

  function currentKey() {
    const idx = quizMode ? quizIdx : activeIdx;
    return (VIEW[idx] || [])[2] || "";
  }

  function updateModeUI() {
    modeEl.textContent = quizMode ? "æµ‹éªŒæ¨¡å¼" : "æ™®é€šæ¨¡å¼";
    el("showAns").style.display = quizMode ? "inline-block" : "none";
    el("playZh").style.display = quizMode ? "inline-block" : "none";
    el("playTh").style.display = quizMode ? "inline-block" : "none";

    // æ™®é€šæ¨¡å¼ä¸‹ï¼šåˆ—è¡¨ç‚¹å‡»æ’­æ”¾ä¸­æ–‡ï¼ˆæ›´ç¬¦åˆâ€œç‚¹è¯»è¯¾ä»¶â€ï¼‰
    if (!quizMode) {
      el("showAns").style.display = "none";
      el("playZh").style.display = "none";
      el("playTh").style.display = "none";
    }
  }

  function updateProgress() {
    const total = VIEW.length || 1;
    const knownCount = VIEW.filter(([, , key]) => known.has(key)).length;
    knownCountEl.textContent = `å·²ç†Ÿæ‚‰ ${knownCount}`;
    barEl.style.width = `${Math.round((knownCount / total) * 100)}%`;
  }

  function renderList() {
    listEl.innerHTML = "";
    VIEW.forEach((it, i) => {
      const [thai, zhpy, key] = it;
      const div = document.createElement("div");
      const isActive = quizMode ? (i === quizIdx) : (i === activeIdx);
      div.className = "item" + (isActive ? " active" : "");
      div.dataset.i = String(i);

      const idx = document.createElement("div");
      idx.className = "idx";
      idx.textContent = String(i + 1).padStart(3, "0");

      const body = document.createElement("div");
      const th = document.createElement("div");
      th.className = "th";
      th.textContent = thai + (known.has(key) ? "  âœ“" : "");

      const zh = document.createElement("div");
      zh.className = "zh";
      zh.textContent = zhpy;

      body.appendChild(th);
      body.appendChild(zh);

      div.appendChild(idx);
      div.appendChild(body);

      div.addEventListener("click", async () => {
        if (quizMode) {
          // æµ‹éªŒæ¨¡å¼ï¼šä¿æŒ CSV é¡ºåºï¼Œä½†å…è®¸è·³é¢˜ï¼ˆä»æ˜¯æŒ‰åŸåºå·å®šä½ï¼‰
          quizIdx = i;
          quizReveal = false;
          renderQuizCard();
          await playThai();
        } else {
          activeIdx = i;
          renderList();
          renderStudyCard();
          await playChinese();
        }
      });

      listEl.appendChild(div);
    });

    countEl.textContent = `${VIEW.length} æ¡`;
    updateProgress();
  }

  function renderStudyCard() {
    if (!VIEW.length) return;
    const [thai, zhpy, key] = VIEW[activeIdx] || VIEW[0];
    const { zh, py } = splitZhPy(zhpy);

    bigTH.textContent = thai;
    bigZH.textContent = zh;
    bigPY.textContent = py;

    keyEl.textContent = key;
    fileEl.textContent = `ZH: ${zhAudioPath(key)}`;
  }

  function renderQuizCard() {
    if (!VIEW.length) return;
    const [thai, zhpy, key] = VIEW[quizIdx] || VIEW[0];
    const { zh, py } = splitZhPy(zhpy);

    bigTH.textContent = `Q${String(quizIdx + 1).padStart(3, "0")}. ${thai}`;
    keyEl.textContent = key;
    fileEl.textContent = `TH: ${thAudioPath(key)} | ZH: ${zhAudioPath(key)}`;

    if (quizReveal) {
      bigZH.textContent = zh;
      bigPY.textContent = py;
    } else {
      bigZH.textContent = "ï¼ˆç‚¹å‡»â€œæ˜¾ç¤ºç­”æ¡ˆâ€ï¼‰";
      bigPY.textContent = "";
    }
  }

  async function safePlay(src) {
    audio.loop = loopPlay.checked;
    audio.src = src;
    try {
      await audio.play();
      return true;
    } catch (e) {
      alert(
        "æ— æ³•æ’­æ”¾éŸ³é¢‘ã€‚è¯·ç¡®è®¤ï¼š\n" +
        "1) phrases.csv ä¸ index.html åŒç›®å½•\n" +
        "2) ä¸­æ–‡éŸ³é¢‘ï¼šaudio/<key>.mp3 å­˜åœ¨\n" +
        "3) æ³°è¯­éŸ³é¢‘ï¼šaudio_th/<key>.mp3 å­˜åœ¨\n" +
        "4) æ‰‹æœºæµè§ˆå™¨éœ€è¦å…ˆæ‰‹åŠ¨ç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘æƒé™\n" +
        "5) å»ºè®®ç”¨é™æ€ç½‘ç«™æ–¹å¼æ‰“å¼€ï¼ˆä¸è¦ç”¨ Drive æ–‡æœ¬é¢„è§ˆï¼‰"
      );
      return false;
    }
  }

  async function playThai() {
    const key = currentKey();
    if (!key) return;
    await safePlay(thAudioPath(key));
  }

  async function playChinese() {
    const key = currentKey();
    if (!key) return;
    await safePlay(zhAudioPath(key));
  }

  function next() {
    if (!VIEW.length) return;
    if (quizMode) {
      quizIdx = (quizIdx + 1) % VIEW.length;
      quizReveal = false;
      renderList();
      renderQuizCard();
    } else {
      activeIdx = (activeIdx + 1) % VIEW.length;
      renderList();
      renderStudyCard();
    }
  }

  function prev() {
    if (!VIEW.length) return;
    if (quizMode) {
      quizIdx = (quizIdx - 1 + VIEW.length) % VIEW.length;
      quizReveal = false;
      renderList();
      renderQuizCard();
    } else {
      activeIdx = (activeIdx - 1 + VIEW.length) % VIEW.length;
      renderList();
      renderStudyCard();
    }
  }

  function shuffle() {
    if (!VIEW.length) return;
    // éšæœºåªå½±å“æ˜¾ç¤ºé¡ºåºï¼Œä¸æ”¹å˜ DATA åŸå§‹é¡ºåºï¼ˆä½ è¦æ±‚â€œä¿æŒ CSV é¡ºåºä¸å˜â€çš„å‡ºé¢˜ï¼›å‡ºé¢˜ç”¨ DATA ç´¢å¼•ï¼‰
    // è¿™é‡Œçš„â€œéšæœºâ€æŒ‰é’®åªéšæœº VIEW å±•ç¤ºï¼ˆæœç´¢åä¹Ÿä¼šå½±å“ï¼‰ã€‚
    VIEW = VIEW.slice().sort(() => Math.random() - 0.5);
    activeIdx = 0;
    quizIdx = 0;
    quizReveal = false;
    renderList();
    quizMode ? renderQuizCard() : renderStudyCard();
  }

  function applyFilter() {
    const q = (qEl.value || "").trim().toLowerCase();
    if (!q) {
      VIEW = DATA.slice();
    } else {
      VIEW = DATA.filter(([thai, zhpy, key]) =>
        thai.toLowerCase().includes(q) ||
        zhpy.toLowerCase().includes(q) ||
        key.toLowerCase().includes(q)
      );
    }
    activeIdx = 0;
    quizIdx = 0;
    quizReveal = false;
    renderList();
    quizMode ? renderQuizCard() : renderStudyCard();
  }

  function markKnown() {
    const key = quizMode ? (VIEW[quizIdx] || [])[2] : (VIEW[activeIdx] || [])[2];
    if (!key) return;
    if (known.has(key)) known.delete(key); else known.add(key);
    localStorage.setItem(KNOWN_KEY, JSON.stringify([...known]));
    renderList();
    updateProgress();
  }

  function resetKnown() {
    if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰â€œå·²ç†Ÿæ‚‰â€æ ‡è®°å—ï¼Ÿ")) return;
    known.clear();
    localStorage.setItem(KNOWN_KEY, "[]");
    renderList();
    updateProgress();
  }

  // ç»“æŸè‡ªåŠ¨ä¸‹ä¸€æ¡ï¼ˆæµ‹éªŒä¸æ™®é€šéƒ½æ”¯æŒï¼‰
  audio.addEventListener("ended", async () => {
    if (!autoNext.checked) return;
    next();
    if (quizMode) {
      await playThai();
    } else {
      await playChinese();
    }
  });

  // ç»‘å®šæŒ‰é’®
  el("clear").addEventListener("click", () => { qEl.value = ""; applyFilter(); });
  qEl.addEventListener("input", () => applyFilter());

  el("next").addEventListener("click", () => next());
  el("prev").addEventListener("click", () => prev());
  el("shuffle").addEventListener("click", () => shuffle());

  el("replay").addEventListener("click", async () => {
    if (quizMode) await playThai();
    else await playChinese();
  });

  el("playTh").addEventListener("click", async () => {
    if (!quizMode) {
      alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
      return;
    }
    await playThai();
  });

  el("playZh").addEventListener("click", async () => {
    if (!quizMode) {
      alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
      return;
    }
    await playChinese();
  });

  el("showAns").addEventListener("click", () => {
    if (!quizMode) {
      alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
      return;
    }
    quizReveal = true;
    renderQuizCard();
  });

  el("quiz").addEventListener("click", async () => {
    quizMode = !quizMode;
    quizReveal = false;

    // ä»å½“å‰å­¦ä¹ ä½ç½®å¼€å§‹
    quizIdx = activeIdx;

    updateModeUI();
    renderList();

    if (quizMode) {
      renderQuizCard();
      await playThai();
    } else {
      renderStudyCard();
    }
  });

  el("mark").addEventListener("click", () => markKnown());
  el("reset").addEventListener("click", () => resetKnown());

  // ------------------------------
  // Lightweight tests (no framework)
  // ------------------------------
  function assert(cond, msg) {
    if (!cond) throw new Error("Test failed: " + msg);
  }
  function runTests() {
    // CSV parsing tests
    const sample = "Thai,Chinese_Pinyin,TTS_Key\nà¸ªà¸§à¸±à¸ªà¸”à¸µ,ä½ å¥½ nÇ hÇo,zh_cn_0001\n";
    const rows = parseCSV(sample);
    assert(rows.length === 2, "parseCSV should return 2 rows incl header");
    const head = rows[0];
    assert(head[0] === "Thai" && head[2] === "TTS_Key", "header columns parsed");

    const s = splitZhPy("ä½ å¥½ nÇ hÇo");
    assert(s.zh === "ä½ å¥½", "splitZhPy zh part");
    assert(s.py.includes("nÇ"), "splitZhPy py part");

    const s2 = splitZhPy("ä¸ç”¨è°¢");
    assert(s2.zh === "ä¸ç”¨è°¢" && s2.py === "", "splitZhPy no pinyin");
  }

  (async function init(){
    try {
      runTests();
      statusEl.textContent = "åŠ è½½ä¸­â€¦";
      DATA = await loadCSV();
      if (!DATA.length) throw new Error("CSV empty");
      VIEW = DATA.slice();
      statusEl.textContent = `å·²åŠ è½½ï¼šphrases.csvï¼ˆ${DATA.length}æ¡ï¼‰`;

      updateModeUI();
      renderList();
      renderStudyCard();
    } catch (e) {
      console.error(e);
      statusEl.textContent = "é”™è¯¯ï¼šæ— æ³•åŠ è½½";
      alert(
        "åˆå§‹åŒ–å¤±è´¥ã€‚\n" +
        "è¯·æ£€æŸ¥ï¼š\n" +
        "1) phrases.csv ä¸ index.html åŒä¸€ç›®å½•\n" +
        "2) CSV ç¼–ç ä¸º UTF-8\n" +
        "3) ä½¿ç”¨é™æ€ç½‘ç«™æ–¹å¼æ‰“å¼€ï¼ˆä¸è¦ç”¨ Drive æ–‡æœ¬é¢„è§ˆï¼‰\n\n" +
        "é”™è¯¯ä¿¡æ¯ï¼š" + (e && e.message ? e.message : String(e))
      );
    }
  })();
</script>
</body>
</html>
