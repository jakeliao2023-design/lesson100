<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#fb7185;
      --border:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai","Noto Sans",sans-serif;background:linear-gradient(180deg,#050915 0%,#0b1220 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px;line-height:1.25}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:420px 1fr}}

    .panel{background:rgba(15,26,48,.7);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .panel .hd{padding:12px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .bd{padding:12px}

    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#081022;color:var(--text);outline:none}
    input[type="text"]::placeholder{color:#64748b}

    .btn{cursor:pointer;border:1px solid var(--border);background:#0a1327;color:var(--text);padding:9px 12px;border-radius:10px;font-weight:600;font-size:13px}
    .btn:hover{border-color:rgba(148,163,184,.4)}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#04110a}
    .btn.secondary{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}
    .btn.danger{background:linear-gradient(90deg,#e11d48,#fb7185);border:none;color:#18040a}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .list{max-height:62vh;overflow:auto}
    .item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
    .item:hover{background:rgba(96,165,250,.08)}
    .item.active{background:rgba(34,197,94,.12)}
    .idx{color:var(--muted);font-variant-numeric:tabular-nums;min-width:38px}
    .th{font-size:15px;line-height:1.4}
    .zh{font-size:14px;color:#c7d2fe;margin-top:3px}

    .card{padding:14px;border-radius:14px;background:rgba(15,26,48,.7);border:1px solid var(--border)}
    .bigTH{font-size:22px;font-weight:800;letter-spacing:.2px}
    .bigZH{margin-top:10px;font-size:20px;font-weight:800}
    .bigPY{margin-top:6px;color:var(--accent2);font-size:15px}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}

    .progress{height:10px;background:#071022;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#16a34a,#22c55e);width:0%}

    .toggle{display:flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
    .toggle input{transform:scale(1.1)}

    .note{color:var(--muted);font-size:12px;line-height:1.5}
    code{background:#071022;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
    .warn{color:#fbbf24}

    /* å¬åŠ›è€ƒè¯•æ¨¡å¼ï¼šå…¨é®æ–‡å­—ï¼ˆæ˜¾ç¤ºä¸ºå ä½å—ï¼‰ï¼Œç‚¹å‡»"æ˜¾ç¤ºç­”æ¡ˆ"æ‰æ¢å¤ */
    body.exam .th, body.exam .zh,
    body.exam #bigTH, body.exam #bigZH, body.exam #bigPY {
      color: transparent !important;
      text-shadow: none !important;
    }
    body.exam .th, body.exam .zh,
    body.exam #bigTH, body.exam #bigZH, body.exam #bigPY {
      position: relative;
    }
    body.exam .th::after,
    body.exam .zh::after,
    body.exam #bigTH::after,
    body.exam #bigZH::after,
    body.exam #bigPY::after {
      content: "";
      position:absolute;left:0;top:50%;transform:translateY(-50%);
      width: min(260px, 85%);
      height: 10px;
      border-radius: 999px;
      background: rgba(148,163,184,.25);
    }
    body.exam .zh::after { height: 8px; opacity:.9; }
    body.exam #bigTH::after { height: 14px; }
    body.exam #bigZH::after { height: 12px; }
    body.exam #bigPY::after { height: 10px; }

    .banner{display:none}
    body.exam .banner{display:block; padding:10px 12px; border:1px dashed rgba(96,165,250,.5); border-radius:12px; color:#c7d2fe; background:rgba(96,165,250,.08)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <h1>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰<br/><span style="font-size:13px;color:#94a3b8">à¸šà¸—à¹€à¸£à¸µà¸¢à¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™ 100 à¸›à¸£à¸°à¹‚à¸¢à¸„ (à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡)</span></h1>
      <span class="pill">ç‚¹å‡»è¯æ¡æ’­æ”¾ Â· TH â†’ ZH<br/>à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</span>
      <span class="pill" id="status">æœªåŠ è½½</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <section class="panel">
      <div class="hd">
        <input id="q" type="text" placeholder="æœç´¢ï¼šæ³°è¯­ / ä¸­æ–‡ / æ‹¼éŸ³ / key â€¦" />
        <button class="btn tight" id="clear">æ¸…ç©º</button>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <button class="btn" id="quiz">ğŸ§ å¬éŸ³é€‰å¥<br/>à¹à¸šà¸šà¸à¸¶à¸à¸«à¸±à¸”à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</button>
          <button class="btn secondary" id="shuffle">éšæœº</button>
          <button class="btn" id="prev">ä¸Šä¸€æ¡</button>
          <button class="btn" id="next">ä¸‹ä¸€æ¡</button>
        </div>

        <div class="row" style="margin-bottom:10px">
          <span class="toggle"><input type="radio" name="speed" id="spdNormal" checked /> æ­£å¸¸è¯­é€Ÿ<br/>à¸„à¸§à¸²à¸¡à¹€à¸£à¹‡à¸§à¸›à¸à¸•à¸´</span>
          <span class="toggle"><input type="radio" name="speed" id="spdSlow" /> æ…¢é€Ÿ<br/>à¸Šà¹‰à¸²</span>
          <span class="toggle"><input type="checkbox" id="exam" /> å¬åŠ›è€ƒè¯•ï¼ˆå…¨é®æ–‡å­—ï¼‰<br/>à¹‚à¸«à¸¡à¸”à¸ªà¸­à¸šà¸Ÿà¸±à¸‡</span>
          <button class="btn" id="reveal">ğŸ‘ æ˜¾ç¤ºç­”æ¡ˆ<br/>à¹à¸ªà¸”à¸‡à¸„à¸³à¸•à¸­à¸š</button>
        </div>

        <div class="banner" id="examBanner">ğŸ§ å¬åŠ›è€ƒè¯•æ¨¡å¼ï¼šå…ˆå¬éŸ³é¢‘ï¼Œå†é€‰ç­”æ¡ˆï¼›å¯ç”¨â€œæ˜¾ç¤ºç­”æ¡ˆâ€æŸ¥çœ‹ã€‚<br/>à¹‚à¸«à¸¡à¸”à¸ªà¸­à¸šà¸Ÿà¸±à¸‡: à¸Ÿà¸±à¸‡à¸à¹ˆà¸­à¸™ à¹à¸¥à¹‰à¸§à¹€à¸¥à¸·à¸­à¸à¸„à¸³à¸•à¸­à¸š</div>

        <div class="progress" title="å­¦ä¹ è¿›åº¦ï¼ˆå·²æ ‡è®°ç†Ÿæ‚‰ï¼‰"><div class="bar" id="bar"></div></div>
        <div class="meta" style="margin:10px 0 0">
          <span id="count">0 æ¡</span>
          <span id="knownCount">å·²ç†Ÿæ‚‰ 0</span>
          <span class="toggle"><input type="checkbox" id="auto" /> è‡ªåŠ¨ä¸‹ä¸€æ¡</span>
          <span class="toggle"><input type="checkbox" id="loop" /> å¾ªç¯æ’­æ”¾</span>
        </div>
      </div>
      <div class="list" id="list"></div>
    </section>

    <section class="panel">
      <div class="hd">
        <button class="btn primary" id="play">â–¶ æ’­æ”¾</button>
        <button class="btn" id="replay">âŸ² é‡æ’­</button>
        <button class="btn" id="mark">âœ“ æ ‡è®°ç†Ÿæ‚‰</button>
        <button class="btn danger" id="reset">é‡ç½®ç†Ÿæ‚‰</button>
      </div>
      <div class="bd">
        <div class="card">
          <div class="bigTH" id="bigTH">â€”</div>
          <div class="bigZH" id="bigZH">â€”</div>
          <div class="bigPY" id="bigPY">â€”</div>
          <div class="meta">
            <span>éŸ³é¢‘ keyï¼š<code id="key">â€”</code></span>
            <span>æ–‡ä»¶ï¼š<code id="file">â€”</code></span>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="note">
          <b>å­¦ä¹ æ¨¡å¼è¯´æ˜ / à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¹‚à¸«à¸¡à¸”à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™:</b><br/>
          â€¢ æ™®é€šæ¨¡å¼ï¼šç‚¹å‡»å¥å­å¬éŸ³å­¦ä¹ <br/>
          â€¢ å¬éŸ³é€‰å¥ï¼šå…ˆå¬å£°éŸ³ï¼Œå†é€‰æ‹©æ­£ç¡®çš„å¥å­<br/>
          â€¢ å¬åŠ›è€ƒè¯•ï¼šå…¨é®æ–‡å­—ï¼ˆå»ºè®®æ­é…â€œå¬éŸ³é€‰å¥â€ï¼‰<br/>
          <br/>
          <b>éŸ³é¢‘æ–‡ä»¶å‘½åï¼š</b><br/>
          æ­£å¸¸è¯­é€Ÿï¼š<code>audio/&lt;key&gt;.mp3</code><br/>
          æ…¢é€Ÿï¼š<code>audio/&lt;key&gt;_slow.mp3</code><br/>
          <br/>
          <b class="warn">æ³¨æ„ï¼š</b>æ‰‹æœºæµè§ˆå™¨é€šå¸¸éœ€è¦å…ˆç‚¹ä¸€æ¬¡ã€Œæ’­æ”¾ã€è§£é”éŸ³é¢‘æƒé™ã€‚<br/>
          à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸: à¸¡à¸·à¸­à¸–à¸·à¸­à¸ˆà¸³à¹€à¸›à¹‡à¸™à¸•à¹‰à¸­à¸‡à¸à¸”à¹€à¸¥à¹ˆà¸™à¸„à¸£à¸±à¹‰à¸‡à¹à¸£à¸à¸à¹ˆà¸­à¸™
        </div>
      </div>
    </section>

  </div>
</main>

<audio id="audio" preload="auto"></audio>

<script>
  const el = (id) => document.getElementById(id);
  const listEl = el("list");
  const qEl = el("q");
  const statusEl = el("status");

  const bigTH = el("bigTH");
  const bigZH = el("bigZH");
  const bigPY = el("bigPY");
  const keyEl = el("key");
  const fileEl = el("file");
  const barEl = el("bar");
  const countEl = el("count");
  const knownCountEl = el("knownCount");

  const audio = el("audio");
  const autoNext = el("auto");
  const loopPlay = el("loop");

  const spdNormal = el("spdNormal");
  const spdSlow = el("spdSlow");
  const examToggle = el("exam");
  const revealBtn = el("reveal");
  const examBanner = el("examBanner");

  let DATA = [];
  let VIEW = [];
  let activeIdx = 0;

  // Quiz state
  let quizMode = false;
  let quizAnswerKey = null;
  let quizOptions = null; // Array<[thai, zhpy, key]> length 4

  const KNOWN_KEY = "lesson100_known_v1";
  const known = new Set(JSON.parse(localStorage.getItem(KNOWN_KEY) || "[]"));

  function shuffleArray(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function parseCSV(csv) {
    const lines = csv.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
    const rows = [];
    for (const line of lines) {
      if (!line.trim()) continue;
      const row = [];
      let cur = "";
      let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === ',' && !inQ) {
          row.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      row.push(cur);
      rows.push(row.map(s => (s || "").trim()));
    }
    return rows;
  }

  async function loadCSV() {
    const res = await fetch("phrases.csv", { cache: "no-store" });
    if (!res.ok) throw new Error("phrases.csv not found");
    const text = await res.text();
    let rows = parseCSV(text);

    const head = (rows[0] || []).map(x => (x || "").toLowerCase());
    const hasHeader = head.includes("thai") || head.includes("chinese_pinyin") || head.includes("tts_key");
    if (hasHeader) rows = rows.slice(1);

    const out = [];
    for (const r of rows) {
      const thai = (r[0] || "").trim();
      const zhpy = (r[1] || "").trim();
      const key = (r[2] || "").trim();
      if (!thai || !zhpy || !key) continue;
      out.push([thai, zhpy, key]);
    }
    return out;
  }

  function splitZhPy(zhpy) {
    // å°è¯•æŠŠâ€œä¸­æ–‡ + ç©ºæ ¼ + æ‹¼éŸ³â€æ‹†å¼€
    const m = zhpy.match(/^(.*?)(\s+[A-Za-zÄÃ¡ÇÃ Ä“Ã©Ä›Ã¨Ä«Ã­ÇÃ¬ÅÃ³Ç’Ã²Å«ÃºÇ”Ã¹Ç–Ç˜ÇšÇœ\s]+.*)$/);
    if (!m) return { zh: zhpy, py: "" };
    return { zh: m[1].trim(), py: m[2].trim() };
  }

  function audioPath(key, preferSlow) {
    return preferSlow ? `audio/${key}_slow.mp3` : `audio/${key}.mp3`;
  }

  function preferredSlow() {
    return !!spdSlow.checked;
  }

  function updateProgress() {
    const total = VIEW.length || 1;
    const knownCount = VIEW.filter(([, , key]) => known.has(key)).length;
    knownCountEl.textContent = `å·²ç†Ÿæ‚‰ ${knownCount}`;
    barEl.style.width = `${Math.round((knownCount / total) * 100)}%`;
  }

  function renderList() {
    listEl.innerHTML = "";

    const source = (quizMode && quizOptions) ? quizOptions : VIEW;

    if (quizMode && quizOptions) {
      countEl.textContent = `å¬éŸ³é€‰å¥ï¼š4 é€‰ 1 / à¹à¸šà¸šà¸à¸¶à¸à¸«à¸±à¸”: à¹€à¸¥à¸·à¸­à¸ 1 à¸ˆà¸²à¸ 4`;
    } else {
      countEl.textContent = `${VIEW.length} æ¡`;
    }

    source.forEach((it, i) => {
      const [thai, zhpy, key] = it;

      const div = document.createElement("div");
      const isActive = (!quizMode) && (key === VIEW[activeIdx]?.[2]);
      div.className = "item" + (isActive ? " active" : "");

      const idx = document.createElement("div");
      idx.className = "idx";
      idx.textContent = String(i + 1).padStart(3, "0");

      const body = document.createElement("div");
      const th = document.createElement("div");
      th.className = "th";
      th.textContent = thai + (!quizMode && known.has(key) ? "  âœ“" : "");

      const zh = document.createElement("div");
      zh.className = "zh";
      zh.textContent = zhpy;

      body.appendChild(th);
      body.appendChild(zh);

      div.appendChild(idx);
      div.appendChild(body);

      div.addEventListener("click", async () => {
        if (quizMode) {
          if (key === quizAnswerKey) {
            alert("âœ… æ­£ç¡® / à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡");
          } else {
            const correct = VIEW.find(x => x[2] === quizAnswerKey);
            alert("âŒ é”™è¯¯ / à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\næ­£ç¡®ç­”æ¡ˆ / à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¸–à¸¹à¸: " + (correct ? correct[0] : ""));
          }

          // é€€å‡ºç»ƒä¹ ï¼Œå›åˆ°æ™®é€šåˆ—è¡¨ï¼Œå¹¶å®šä½åˆ°æ­£ç¡®å¥
          quizMode = false;
          quizOptions = null;
          const idxInView = VIEW.findIndex(x => x[2] === quizAnswerKey);
          renderList();
          if (idxInView >= 0) select(idxInView, true);
          return;
        }

        // æ™®é€šæ¨¡å¼ï¼šæŒ‰ key å®šä½
        const idxInView = VIEW.findIndex(x => x[2] === key);
        select(idxInView >= 0 ? idxInView : 0, true);
      });

      listEl.appendChild(div);
    });

    updateProgress();
  }

  function select(i, scrollIntoView) {
    if (i < 0 || i >= VIEW.length) return;
    activeIdx = i;

    const [thai, zhpy, key] = VIEW[activeIdx];
    const { zh, py } = splitZhPy(zhpy);

    bigTH.textContent = thai;
    bigZH.textContent = zh;
    bigPY.textContent = py;

    keyEl.textContent = key;
    fileEl.textContent = preferredSlow() ? audioPath(key, true) : audioPath(key, false);

    if (!quizMode) {
      [...listEl.querySelectorAll(".item")].forEach((node) => node.classList.remove("active"));
      // ä»…åœ¨æ™®é€šåˆ—è¡¨æ—¶å°è¯•é«˜äº®å½“å‰é¡¹
      const nodes = [...listEl.querySelectorAll(".item")];
      // activeIdx å¯¹åº” VIEW ç´¢å¼•ï¼ŒrenderList ä¹Ÿç”¨ VIEWï¼Œæ‰€ä»¥å¯¹é½
      if (nodes[activeIdx]) nodes[activeIdx].classList.add("active");
    }

    if (scrollIntoView && !quizMode) {
      const node = listEl.querySelectorAll(".item")[activeIdx];
      node?.scrollIntoView({ block: "nearest" });
    }
  }

  async function playKey(key) {
    // ä¼˜å…ˆæ’­æ”¾æ…¢é€Ÿï¼›å¦‚æœæ²¡æœ‰æ…¢é€Ÿæ–‡ä»¶ï¼Œè‡ªåŠ¨å›é€€åˆ°æ­£å¸¸
    const slow = preferredSlow();
    const try1 = audioPath(key, slow);
    const try2 = audioPath(key, false);

    audio.loop = false;
    audio.src = try1;

    try {
      await audio.play();
      return;
    } catch (e) {
      // å¯èƒ½æ˜¯æµè§ˆå™¨æƒé™é—®é¢˜ï¼Œæˆ–èµ„æº 404
    }

    // å°è¯•å›é€€åˆ°æ­£å¸¸è¯­é€Ÿ
    audio.src = try2;
    try {
      await audio.play();
    } catch (e) {
      alert("æ— æ³•æ’­æ”¾éŸ³é¢‘ã€‚\n1) ç¡®è®¤ audio/ ä¸‹å­˜åœ¨å¯¹åº” mp3\n2) æ‰‹æœºéœ€å…ˆç‚¹ä¸€æ¬¡æ’­æ”¾è§£é”æƒé™\n3) å»ºè®®ç”¨ GitHub Pages/é™æ€ç½‘ç«™æ‰“å¼€");
    }
  }

  async function playCurrent() {
    const [, , key] = VIEW[activeIdx] || [];
    if (!key) return;
    audio.loop = loopPlay.checked;
    await playKey(key);
  }

  function next() {
    if (!VIEW.length) return;
    select((activeIdx + 1) % VIEW.length, true);
  }

  function prev() {
    if (!VIEW.length) return;
    select((activeIdx - 1 + VIEW.length) % VIEW.length, true);
  }

  function shuffle() {
    if (!VIEW.length) return;
    const curKey = VIEW[activeIdx]?.[2];
    VIEW = shuffleArray(VIEW);
    renderList();
    const newIdx = VIEW.findIndex((x) => x[2] === curKey);
    select(newIdx >= 0 ? newIdx : 0, true);
  }

  function applyFilter() {
    const q = (qEl.value || "").trim().toLowerCase();

    // è¿‡æ»¤æ—¶é€€å‡ºç»ƒä¹ 
    quizMode = false;
    quizOptions = null;

    if (!q) {
      VIEW = DATA.slice();
    } else {
      VIEW = DATA.filter(([thai, zhpy, key]) =>
        thai.toLowerCase().includes(q) ||
        zhpy.toLowerCase().includes(q) ||
        key.toLowerCase().includes(q)
      );
    }

    activeIdx = 0;
    renderList();
    if (VIEW.length) select(0, false);
  }

  function markKnown() {
    const [, , key] = VIEW[activeIdx] || [];
    if (!key) return;
    if (known.has(key)) known.delete(key); else known.add(key);
    localStorage.setItem(KNOWN_KEY, JSON.stringify([...known]));
    renderList();
    select(activeIdx, false);
  }

  function resetKnown() {
    if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰â€œå·²ç†Ÿæ‚‰â€æ ‡è®°å—ï¼Ÿ")) return;
    known.clear();
    localStorage.setItem(KNOWN_KEY, "[]");
    renderList();
    select(activeIdx, false);
  }

  function startQuiz() {
    if (!VIEW.length) return;
    if (VIEW.length < 4) {
      alert("æ¡ç›®å¤ªå°‘ï¼Œæ— æ³•è¿›å…¥å¬éŸ³é€‰å¥ï¼ˆéœ€è¦è‡³å°‘ 4 æ¡ï¼‰ã€‚");
      return;
    }

    quizMode = true;

    const answer = VIEW[Math.floor(Math.random() * VIEW.length)];
    quizAnswerKey = answer[2];

    const others = VIEW.filter(x => x[2] !== quizAnswerKey);
    const picks = shuffleArray(others).slice(0, 3);
    quizOptions = shuffleArray(picks.concat([answer]));

    renderList();
    playKey(quizAnswerKey);
  }

  function setExamMode(on) {
    document.body.classList.toggle("exam", !!on);
    examBanner.style.display = on ? "block" : "none";
    if (on) {
      statusEl.textContent = "å¬åŠ›è€ƒè¯•æ¨¡å¼ / à¹‚à¸«à¸¡à¸”à¸ªà¸­à¸šà¸Ÿà¸±à¸‡";
    } else {
      statusEl.textContent = `å·²åŠ è½½ï¼šphrases.csvï¼ˆ${DATA.length}æ¡ï¼‰`;
    }
  }

  function revealOnce() {
    // ä¸´æ—¶æ˜¾ç¤ºç­”æ¡ˆ 3 ç§’
    const was = document.body.classList.contains("exam");
    if (!was) return;
    document.body.classList.remove("exam");
    setTimeout(() => document.body.classList.add("exam"), 3000);
  }

  audio.addEventListener("ended", async () => {
    if (!autoNext.checked) return;
    if (quizMode) return;
    next();
    await playCurrent();
  });

  // Buttons
  el("play").addEventListener("click", () => playCurrent());
  el("replay").addEventListener("click", () => playCurrent());
  el("next").addEventListener("click", () => next());
  el("prev").addEventListener("click", () => prev());
  el("shuffle").addEventListener("click", () => shuffle());
  el("quiz").addEventListener("click", () => startQuiz());

  el("mark").addEventListener("click", () => markKnown());
  el("reset").addEventListener("click", () => resetKnown());
  el("clear").addEventListener("click", () => { qEl.value = ""; applyFilter(); });
  qEl.addEventListener("input", () => applyFilter());

  // Speed toggle affects only fileEl preview; playback reads current selection each time
  spdNormal.addEventListener("change", () => select(activeIdx, false));
  spdSlow.addEventListener("change", () => select(activeIdx, false));

  // Exam mode
  examToggle.addEventListener("change", (e) => setExamMode(e.target.checked));
  revealBtn.addEventListener("click", () => revealOnce());

  // Init
  (async function init(){
    try {
      statusEl.textContent = "åŠ è½½ä¸­â€¦";
      DATA = await loadCSV();
      if (!DATA.length) throw new Error("CSV empty");
      VIEW = DATA.slice();
      statusEl.textContent = `å·²åŠ è½½ï¼šphrases.csvï¼ˆ${DATA.length}æ¡ï¼‰`;
      renderList();
      select(0, false);
    } catch (e) {
      statusEl.textContent = "é”™è¯¯ï¼šæ‰¾ä¸åˆ° phrases.csv";
      alert("æ‰¾ä¸åˆ° phrases.csvã€‚è¯·æŠŠ phrases.csv æ”¾åœ¨ index.html åŒä¸€ç›®å½•ã€‚\nå¹¶ç¡®ä¿ç”¨é™æ€ç½‘ç«™æ–¹å¼æ‰“å¼€ï¼ˆä¸è¦ç”¨ Drive æ–‡æœ¬é¢„è§ˆï¼‰ã€‚");
    }
  })();
</script>
</body>
</html>
