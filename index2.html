<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#fb7185;
      --border:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai","Noto Sans",sans-serif;background:linear-gradient(180deg,#050915 0%,#0b1220 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:380px 1fr}}

    .panel{background:rgba(15,26,48,.7);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .panel .hd{padding:12px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .bd{padding:12px}

    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#081022;color:var(--text);outline:none}
    input[type="text"]::placeholder{color:#64748b}

    .btn{cursor:pointer;border:1px solid var(--border);background:#0a1327;color:var(--text);padding:9px 12px;border-radius:10px;font-weight:600;font-size:13px}
    .btn:hover{border-color:rgba(148,163,184,.4)}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#04110a}
    .btn.secondary{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}
    .btn.danger{background:linear-gradient(90deg,#e11d48,#fb7185);border:none;color:#18040a}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .list{max-height:62vh;overflow:auto}
    .item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
    .item:hover{background:rgba(96,165,250,.08)}
    .item.active{background:rgba(34,197,94,.12)}
    .idx{color:var(--muted);font-variant-numeric:tabular-nums;min-width:38px}
    .th{font-size:15px;line-height:1.4}
    .zh{font-size:14px;color:#c7d2fe;margin-top:3px}

    .card{padding:14px;border-radius:14px;background:rgba(15,26,48,.7);border:1px solid var(--border)}
    .bigTH{font-size:22px;font-weight:800;letter-spacing:.2px}
    .bigZH{margin-top:10px;font-size:20px;font-weight:800}
    .bigPY{margin-top:6px;color:var(--accent2);font-size:15px}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}

    .progress{height:10px;background:#071022;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#16a34a,#22c55e);width:0%}

    .toggle{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .toggle input{transform:scale(1.1)}

    .note{color:var(--muted);font-size:12px;line-height:1.5}
    code{background:#071022;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
    .warn{color:#fbbf24}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(8,16,34,.6);color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <h1>
        ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰
        <br/><span style="font-size:13px;color:#94a3b8">à¸šà¸—à¹€à¸£à¸µà¸¢à¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™ 100 à¸›à¸£à¸°à¹‚à¸¢à¸„ (à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡)</span>
      </h1>
      <span class="pill">æ™®é€šæ¨¡å¼ï¼šç‚¹åˆ—è¡¨æ’­æ”¾ä¸­æ–‡ï½œæµ‹éªŒï¼šé¢˜ç›®æ³°è¯­+æ³°è¯­éŸ³é¢‘ï¼›é€‰æ‹©é¢˜ï¼šå››é€‰ä¸€ï¼ˆä¸­æ–‡+æ‹¼éŸ³ï¼‰</span>
      <span class="pill" id="status">æœªåŠ è½½</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- å·¦ä¾§ï¼šåˆ—è¡¨ -->
    <section class="panel">
      <div class="hd">
        <input id="q" type="text" placeholder="æœç´¢ï¼šæ³°è¯­ / ä¸­æ–‡ / æ‹¼éŸ³ / key â€¦" />
        <button class="btn tight" id="clear">æ¸…ç©º</button>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <button class="btn" id="quiz">ğŸ§ å¬éŸ³é—®ç­”<br/>à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸šà¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</button>
          <button class="btn secondary" id="shuffle">éšæœº</button>
          <button class="btn" id="prev">ä¸Šä¸€æ¡</button>
          <button class="btn" id="next">ä¸‹ä¸€æ¡</button>
        </div>
        <div class="progress" title="å­¦ä¹ è¿›åº¦ï¼ˆå·²æ ‡è®°ç†Ÿæ‚‰ï¼‰"><div class="bar" id="bar"></div></div>
        <div class="meta" style="margin:10px 0 0">
          <span id="count">0 æ¡</span>
          <span id="knownCount">å·²ç†Ÿæ‚‰ 0</span>
          <span class="toggle"><input type="checkbox" id="auto" /> è‡ªåŠ¨ä¸‹ä¸€é¢˜</span>
          <span class="toggle"><input type="checkbox" id="loop" /> å¾ªç¯æ’­æ”¾</span>
          <span class="badge" id="mode">æ™®é€šæ¨¡å¼</span>
        </div>
      </div>
      <div class="list" id="list"></div>
    </section>

    <!-- å³ä¾§ï¼šå¡ç‰‡ -->
    <section class="panel">
      <div class="hd">
        <button class="btn primary" id="playTh">â–¶ æ’­æ”¾æ³°è¯­<br/>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</button>
        <button class="btn" id="replay">âŸ² é‡æ’­</button>
        <button class="btn secondary" id="showAns">ğŸ‘ æ˜¾ç¤ºç­”æ¡ˆ<br/>à¸”à¸¹à¸„à¸³à¸•à¸­à¸š</button>
        <button class="btn secondary" id="mcqMode">ğŸ…°ğŸ…± é€‰æ‹©é¢˜<br/>à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸</button>
        <button class="btn" id="playZh">â–¶ æ’­æ”¾ä¸­æ–‡<br/>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™</button>
        <button class="btn" id="mark">âœ“ æ ‡è®°ç†Ÿæ‚‰</button>
        <button class="btn danger" id="reset">é‡ç½®ç†Ÿæ‚‰</button>
      </div>

      <div class="bd">
        <div class="card">
          <div class="bigTH" id="bigTH">â€”</div>
          <div class="bigZH" id="bigZH">â€”</div>
          <div class="bigPY" id="bigPY">â€”</div>
          <div class="meta">
            <span>éŸ³é¢‘ keyï¼š<code id="key">â€”</code></span>
            <span>æ–‡ä»¶ï¼š<code id="file">â€”</code></span>
            <span>é”™é¢˜ï¼š<code id="wrongStat">0</code></span>
          </div>
        </div>

        <div style="height:12px"></div>

        <!-- é€‰æ‹©é¢˜åŒºåŸŸï¼ˆä»…æµ‹éªŒæ¨¡å¼æ˜¾ç¤ºï¼‰ -->
        <div class="card" id="mcq" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div style="font-weight:800">é€‰æ‹©é¢˜ï¼ˆå››é€‰ä¸€ï¼‰<span style="font-weight:600;color:#94a3b8">ï½œà¸„à¸³à¸–à¸²à¸¡à¹à¸šà¸šà¹€à¸¥à¸·à¸­à¸à¸•à¸­à¸š</span></div>
            <div class="row" style="margin:0">
              <button class="btn tight" id="wrongOnlyBtn">åªç»ƒé”™é¢˜ï¼šå…³</button>
              <button class="btn danger tight" id="clearWrong">æ¸…ç©ºé”™é¢˜</button>
            </div>
          </div>
          <div style="height:10px"></div>
          <div id="choices" class="row" style="flex-direction:column;align-items:stretch"></div>
          <div style="height:10px"></div>
          <div class="note" id="mcqHint">ç‚¹å‡»é€‰é¡¹ä½œç­”ã€‚ç­”å®Œä¼šæ˜¾ç¤ºæ­£è¯¯ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚</div>
        </div>

        <div style="height:12px"></div>

        <div class="note">
          <b>æ–‡ä»¶ç»“æ„ï¼ˆåŒä¸€æ–‡ä»¶å¤¹ï¼‰:</b><br/>
          <code>index2.html</code>ï¼ˆæœ¬æ–‡ä»¶ï¼‰<br/>
          <code>phrases.csv</code>ï¼ˆ3åˆ—ï¼šThai,Chinese_Pinyin,TTS_Keyï¼‰<br/>
          <code>audio/</code>ï¼ˆä¸­æ–‡éŸ³é¢‘ï¼‰<code>&lt;key&gt;.mp3</code>ï¼ˆä¾‹å¦‚ <code>audio/zh_cn_0001.mp3</code>ï¼‰<br/>
          <code>audio_th/</code>ï¼ˆæ³°è¯­éŸ³é¢‘ï¼‰<code>th_0001.mp3</code>ï¼ˆä¾‹å¦‚ <code>audio_th/th_0001.mp3</code>ï¼‰<br/>
          <br/>
          <b class="warn">æ³¨æ„ï¼š</b>æ‰‹æœºæµè§ˆå™¨é€šå¸¸éœ€è¦å…ˆç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘æƒé™ã€‚
        </div>
      </div>
    </section>

  </div>
</main>

<audio id="audio" preload="auto"></audio>

<script>
"use strict";

/** ========== DOM ========== */
const el = (id) => document.getElementById(id);
const listEl = el("list");
const qEl = el("q");
const statusEl = el("status");
const modeEl = el("mode");

const bigTH = el("bigTH");
const bigZH = el("bigZH");
const bigPY = el("bigPY");
const keyEl = el("key");
const fileEl = el("file");
const wrongStatEl = el("wrongStat");

const barEl = el("bar");
const countEl = el("count");
const knownCountEl = el("knownCount");

const audio = el("audio");
const autoNext = el("auto");
const loopPlay = el("loop");

const mcqCard = el("mcq");
const choicesEl = el("choices");
const mcqHintEl = el("mcqHint");

/** ========== State ========== */
let DATA = []; // åŸå§‹ CSV é¡ºåº
let VIEW = []; // æœç´¢è¿‡æ»¤åçš„è§†å›¾ï¼ˆä¿æŒç›¸å¯¹é¡ºåºï¼‰
let activeIdx = 0;

// æµ‹éªŒæ¨¡å¼
let quizMode = false;
let quizIdx = 0;
let quizReveal = false;

// é€‰æ‹©é¢˜
let mcqEnabled = false;
let currentChoices = null; // { correctKey, options:[{key, zh, py}] }
let answered = false;

// é”™é¢˜ä¸ç†Ÿæ‚‰
const KNOWN_KEY = "lesson100_known_v1";
const WRONG_KEY = "lesson100_wrong_v1"; // { key: count }

const known = new Set(JSON.parse(localStorage.getItem(KNOWN_KEY) || "[]"));
const wrongMap = JSON.parse(localStorage.getItem(WRONG_KEY) || "{}") || {};
let wrongOnly = false;

/** ========== Utils ========== */
function saveWrongMap() {
  localStorage.setItem(WRONG_KEY, JSON.stringify(wrongMap));
  updateWrongStat();
}

function updateWrongStat() {
  const keys = Object.keys(wrongMap);
  const totalWrong = keys.reduce((acc, k) => acc + (Number(wrongMap[k]) || 0), 0);
  wrongStatEl.textContent = `${keys.length}é¢˜/${totalWrong}æ¬¡`;
}

function parseCSV(csv) {
  const lines = csv.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
  const rows = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const row = [];
    let cur = "";
    let inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === ',' && !inQ) {
        row.push(cur); cur = "";
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    rows.push(row.map(s => (s || "").trim()));
  }
  return rows;
}

async function loadCSV() {
  const res = await fetch("phrases.csv", { cache: "no-store" });
  if (!res.ok) throw new Error("phrases.csv not found");
  const text = await res.text();
  let rows = parseCSV(text);

  // è¡¨å¤´åˆ¤æ–­
  const head = (rows[0] || []).map(x => (x || "").toLowerCase());
  const hasHeader = head.includes("thai") || head.includes("chinese_pinyin") || head.includes("tts_key");
  if (hasHeader) rows = rows.slice(1);

  const out = [];
  for (const r of rows) {
    const thai = (r[0] || "").trim();
    const zhpy = (r[1] || "").trim();
    const key = (r[2] || "").trim();
    if (!thai || !zhpy || !key) continue;
    out.push([thai, zhpy, key]);
  }
  return out;
}

function splitZhPy(zhpy) {
  // æœŸæœ›æ ¼å¼ï¼šâ€œä¸­æ–‡ æ‹¼éŸ³â€
  const m = zhpy.match(/^(.*?)(\s+[A-Za-zÄÃ¡ÇÃ Ä“Ã©Ä›Ã¨Ä«Ã­ÇÃ¬ÅÃ³Ç’Ã²Å«ÃºÇ”Ã¹Ç–Ç˜ÇšÇœ\s]+.*)$/);
  if (!m) return { zh: zhpy, py: "" };
  return { zh: m[1].trim(), py: m[2].trim() };
}

function zhAudioPath(key) {
  return `audio/${key}.mp3`;
}

function thAudioPath(key) {
  const m = key.match(/(\d+)$/);
  const num = m ? m[1].padStart(4, "0") : "0001";
  return "audio_th/th_" + num + ".mp3";
}

function currentItem() {
  const idx = quizMode ? quizIdx : activeIdx;
  return VIEW[idx] || null;
}
function currentKey() {
  const it = currentItem();
  return it ? it[2] : "";
}

function updateModeUI() {
  modeEl.textContent = quizMode ? "æµ‹éªŒæ¨¡å¼" : "æ™®é€šæ¨¡å¼";

  el("showAns").style.display = quizMode ? "inline-block" : "none";
  el("playZh").style.display = quizMode ? "inline-block" : "none";
  el("playTh").style.display = quizMode ? "inline-block" : "none";
  el("mcqMode").style.display = quizMode ? "inline-block" : "none";

  if (!quizMode) {
    mcqCard.style.display = "none";
  } else {
    mcqCard.style.display = mcqEnabled ? "block" : "none";
  }
}

function updateProgress() {
  const total = VIEW.length || 1;
  const knownCount = VIEW.filter(([, , key]) => known.has(key)).length;
  knownCountEl.textContent = `å·²ç†Ÿæ‚‰ ${knownCount}`;
  barEl.style.width = `${Math.round((knownCount / total) * 100)}%`;
  updateWrongStat();
}

function renderList() {
  listEl.innerHTML = "";
  VIEW.forEach((it, i) => {
    const [thai, zhpy, key] = it;
    const div = document.createElement("div");
    const isActive = quizMode ? (i === quizIdx) : (i === activeIdx);
    div.className = "item" + (isActive ? " active" : "");

    const idx = document.createElement("div");
    idx.className = "idx";
    idx.textContent = String(i + 1).padStart(3, "0");

    const body = document.createElement("div");

    const th = document.createElement("div");
    th.className = "th";
    const wrongTag = wrongMap[key] ? `  âœ—${wrongMap[key]}` : "";
    th.textContent = thai + (known.has(key) ? "  âœ“" : "") + wrongTag;

    const zh = document.createElement("div");
    zh.className = "zh";
    zh.textContent = zhpy;

    body.appendChild(th);
    body.appendChild(zh);

    div.appendChild(idx);
    div.appendChild(body);

    div.addEventListener("click", async () => {
      if (quizMode) {
        quizIdx = i;
        quizReveal = false;
        answered = false;
        currentChoices = null;
        mcqHintEl.textContent = "ç‚¹å‡»é€‰é¡¹ä½œç­”ã€‚ç­”å®Œä¼šæ˜¾ç¤ºæ­£è¯¯ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚";
        renderList();
        renderQuizCard();
        if (mcqEnabled) buildChoices();
        await playThai();
      } else {
        activeIdx = i;
        renderList();
        renderStudyCard();
        await playChinese();
      }
    });

    listEl.appendChild(div);
  });

  countEl.textContent = `${VIEW.length} æ¡`;
  updateProgress();
}

function renderStudyCard() {
  if (!VIEW.length) return;
  const [thai, zhpy, key] = VIEW[activeIdx] || VIEW[0];
  const { zh, py } = splitZhPy(zhpy);

  bigTH.textContent = thai;
  bigZH.textContent = zh;
  bigPY.textContent = py;

  keyEl.textContent = key;
  fileEl.textContent = `ZH: ${zhAudioPath(key)}`;
}

function renderQuizCard() {
  if (!VIEW.length) return;
  const [thai, zhpy, key] = VIEW[quizIdx] || VIEW[0];
  const { zh, py } = splitZhPy(zhpy);

  bigTH.textContent = `Q${String(quizIdx + 1).padStart(3, "0")}. ${thai}`;
  keyEl.textContent = key;
  fileEl.textContent = `TH: ${thAudioPath(key)} | ZH: ${zhAudioPath(key)}`;

  if (!mcqEnabled) {
    // ä¼ ç»Ÿâ€œæ˜¾ç¤ºç­”æ¡ˆâ€
    mcqCard.style.display = "none";
    if (quizReveal) {
      bigZH.textContent = zh;
      bigPY.textContent = py;
    } else {
      bigZH.textContent = "ï¼ˆç‚¹å‡»â€œæ˜¾ç¤ºç­”æ¡ˆâ€ï¼‰";
      bigPY.textContent = "";
    }
  } else {
    // é€‰æ‹©é¢˜
    mcqCard.style.display = "block";
    if (answered) {
      bigZH.textContent = zh;
      bigPY.textContent = py;
    } else {
      bigZH.textContent = "ï¼ˆè¯·é€‰æ‹©æ­£ç¡®ä¸­æ–‡ + æ‹¼éŸ³ï¼‰";
      bigPY.textContent = "";
    }
  }
}

/** ========== MCQ ========== */
function randInt(n) { return Math.floor(Math.random() * n); }
function shuffleInPlace(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function buildChoices() {
  const it = currentItem();
  if (!it) return;

  const [, zhpy, key] = it;
  const { zh, py } = splitZhPy(zhpy);

  const options = [{ key, zh, py }];

  // å– 3 ä¸ªå¹²æ‰°é¡¹
  const pool = VIEW.filter(x => x[2] !== key);
  const need = Math.min(3, pool.length);
  const used = new Set([key]);

  while (options.length < 1 + need) {
    const pick = pool[randInt(pool.length)];
    const pKey = pick[2];
    if (used.has(pKey)) continue;
    used.add(pKey);
    const p = splitZhPy(pick[1]);
    options.push({ key: pKey, zh: p.zh, py: p.py });
  }

  shuffleInPlace(options);
  currentChoices = { correctKey: key, options };
  answered = false;
  renderChoicesUI();
}

function renderChoicesUI() {
  choicesEl.innerHTML = "";
  if (!mcqEnabled || !quizMode || !currentChoices) return;

  const letters = ["A", "B", "C", "D"];
  currentChoices.options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.style.textAlign = "left";
    btn.style.width = "100%";
    btn.dataset.key = opt.key;

    // âœ… é€‰é¡¹æ˜¾ç¤ºï¼šä¸­æ–‡ + æ‹¼éŸ³ï¼ˆæŒ‰ä½ çš„é€‰æ‹© 2ï¼‰
    btn.textContent = `${letters[idx] || "Â·"}. ${opt.zh}  (${opt.py})`;

    // å·²ç­”ï¼šé«˜äº®æ­£ç¡®ç­”æ¡ˆ
    if (answered && opt.key === currentChoices.correctKey) {
      btn.className = "btn primary";
    }

    btn.addEventListener("click", async () => {
      if (answered) return;
      answered = true;

      const chosenKey = opt.key;
      const correctKey = currentChoices.correctKey;

      if (chosenKey === correctKey) {
        mcqHintEl.textContent = "âœ… æ­£ç¡®ï¼å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬ä¸€éã€‚";
      } else {
        mcqHintEl.textContent = "âŒ é”™äº†ã€‚å·²åŠ å…¥é”™é¢˜æœ¬ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚";
        wrongMap[correctKey] = (Number(wrongMap[correctKey]) || 0) + 1;
        saveWrongMap();
      }

      renderQuizCard();
      renderChoicesUI();

      // è‡ªåŠ¨ä¸‹ä¸€é¢˜ï¼ˆå¦‚æœå¼€å¯ï¼‰
      if (autoNext.checked) {
        setTimeout(async () => {
          next();
          if (quizMode) {
            if (mcqEnabled) buildChoices();
            await playThai();
          }
        }, 600);
      }
    });

    choicesEl.appendChild(btn);
  });
}

function getQuizPoolIndices() {
  // åªç»ƒé”™é¢˜ï¼šæŒ‰ VIEW é¡ºåºæŒ‘å‡ºå‡ºç°è¿‡é”™çš„ key
  if (!wrongOnly) return VIEW.map((_, i) => i);
  const keys = new Set(Object.keys(wrongMap));
  const arr = [];
  for (let i = 0; i < VIEW.length; i++) {
    if (keys.has(VIEW[i][2])) arr.push(i);
  }
  return arr.length ? arr : VIEW.map((_, i) => i); // æ²¡é”™é¢˜åˆ™å›é€€å…¨é¢˜
}

/** ========== Audio ========== */
async function safePlay(src) {
  audio.loop = loopPlay.checked;
  audio.src = src;
  try {
    await audio.play();
    return true;
  } catch (e) {
    alert(
      "æ— æ³•æ’­æ”¾éŸ³é¢‘ã€‚è¯·ç¡®è®¤ï¼š\n" +
      "1) phrases.csv ä¸ index2.html åŒç›®å½•\n" +
      "2) ä¸­æ–‡éŸ³é¢‘ï¼šaudio/<key>.mp3 å­˜åœ¨ï¼ˆä¾‹å¦‚ audio/zh_cn_0001.mp3ï¼‰\n" +
      "3) æ³°è¯­éŸ³é¢‘ï¼šaudio_th/th_0001.mp3 å­˜åœ¨\n" +
      "4) æ‰‹æœºæµè§ˆå™¨éœ€è¦å…ˆæ‰‹åŠ¨ç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘æƒé™\n" +
      "5) å»ºè®®ç”¨é™æ€ç½‘ç«™æ–¹å¼æ‰“å¼€ï¼ˆä¸è¦ç”¨ Drive æ–‡æœ¬é¢„è§ˆï¼‰"
    );
    return false;
  }
}
async function playThai() {
  const key = currentKey();
  if (!key) return;
  await safePlay(thAudioPath(key));
}
async function playChinese() {
  const key = currentKey();
  if (!key) return;
  await safePlay(zhAudioPath(key));
}

/** ========== Navigation ========== */
function next() {
  if (!VIEW.length) return;

  if (quizMode) {
    const pool = getQuizPoolIndices();
    const curPos = pool.indexOf(quizIdx);
    const nextPos = (curPos + 1) % pool.length;
    quizIdx = pool[nextPos];

    quizReveal = false;
    answered = false;
    currentChoices = null;

    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  } else {
    activeIdx = (activeIdx + 1) % VIEW.length;
    renderList();
    renderStudyCard();
  }
}

function prev() {
  if (!VIEW.length) return;

  if (quizMode) {
    const pool = getQuizPoolIndices();
    const curPos = pool.indexOf(quizIdx);
    const prevPos = (curPos - 1 + pool.length) % pool.length;
    quizIdx = pool[prevPos];

    quizReveal = false;
    answered = false;
    currentChoices = null;

    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  } else {
    activeIdx = (activeIdx - 1 + VIEW.length) % VIEW.length;
    renderList();
    renderStudyCard();
  }
}

function shuffle() {
  if (!VIEW.length) return;
  VIEW = VIEW.slice().sort(() => Math.random() - 0.5);
  activeIdx = 0;
  quizIdx = 0;
  quizReveal = false;
  answered = false;
  currentChoices = null;
  renderList();
  quizMode ? renderQuizCard() : renderStudyCard();
  if (quizMode && mcqEnabled) buildChoices();
}

function applyFilter() {
  const q = (qEl.value || "").trim().toLowerCase();
  if (!q) {
    VIEW = DATA.slice();
  } else {
    VIEW = DATA.filter(([thai, zhpy, key]) =>
      thai.toLowerCase().includes(q) ||
      zhpy.toLowerCase().includes(q) ||
      key.toLowerCase().includes(q)
    );
  }
  activeIdx = 0;
  quizIdx = 0;
  quizReveal = false;
  answered = false;
  currentChoices = null;

  renderList();
  quizMode ? renderQuizCard() : renderStudyCard();
  if (quizMode && mcqEnabled) buildChoices();
}

/** ========== Known / Wrong controls ========== */
function markKnown() {
  const key = quizMode ? (VIEW[quizIdx] || [])[2] : (VIEW[activeIdx] || [])[2];
  if (!key) return;
  if (known.has(key)) known.delete(key);
  else known.add(key);
  localStorage.setItem(KNOWN_KEY, JSON.stringify([...known]));
  renderList();
  updateProgress();
}

function resetKnown() {
  if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰â€œå·²ç†Ÿæ‚‰â€æ ‡è®°å—ï¼Ÿ")) return;
  known.clear();
  localStorage.setItem(KNOWN_KEY, "[]");
  renderList();
  updateProgress();
}

function clearWrong() {
  if (!confirm("ç¡®å®šè¦æ¸…ç©ºé”™é¢˜è®°å½•å—ï¼Ÿ")) return;
  for (const k of Object.keys(wrongMap)) delete wrongMap[k];
  saveWrongMap();
  renderList();
  if (quizMode && mcqEnabled) {
    answered = false;
    currentChoices = null;
    buildChoices();
    renderQuizCard();
  }
}

/** ========== Events ========== */
// éŸ³é¢‘ç»“æŸï¼šè‡ªåŠ¨ä¸‹ä¸€é¢˜ï¼ˆæµ‹éªŒ=æ’­æ³°è¯­ï¼›æ™®é€š=æ’­ä¸­æ–‡ï¼‰
audio.addEventListener("ended", async () => {
  if (!autoNext.checked) return;
  next();
  if (quizMode) {
    if (mcqEnabled) buildChoices();
    await playThai();
  } else {
    await playChinese();
  }
});

// æœç´¢
el("clear").addEventListener("click", () => { qEl.value = ""; applyFilter(); });
qEl.addEventListener("input", () => applyFilter());

// ç¿»é¡µ/éšæœº
el("next").addEventListener("click", () => next());
el("prev").addEventListener("click", () => prev());
el("shuffle").addEventListener("click", () => shuffle());

// æ’­æ”¾
el("replay").addEventListener("click", async () => {
  if (quizMode) await playThai();
  else await playChinese();
});

el("playTh").addEventListener("click", async () => {
  if (!quizMode) { alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰"); return; }
  await playThai();
});

el("playZh").addEventListener("click", async () => {
  if (!quizMode) { alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰"); return; }
  await playChinese();
});

// æ˜¾ç¤ºç­”æ¡ˆï¼ˆä»…éé€‰æ‹©é¢˜ï¼‰
el("showAns").addEventListener("click", () => {
  if (!quizMode) { alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰"); return; }
  if (mcqEnabled) { alert("é€‰æ‹©é¢˜æ¨¡å¼ä¸‹ï¼šè¯·ç›´æ¥ä½œç­”ï¼›ç­”å®Œä¼šæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆã€‚"); return; }
  quizReveal = true;
  renderQuizCard();
});

// åˆ‡æ¢é€‰æ‹©é¢˜
el("mcqMode").addEventListener("click", () => {
  if (!quizMode) { alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰"); return; }
  mcqEnabled = !mcqEnabled;
  answered = false;
  currentChoices = null;
  mcqHintEl.textContent = "ç‚¹å‡»é€‰é¡¹ä½œç­”ã€‚ç­”å®Œä¼šæ˜¾ç¤ºæ­£è¯¯ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚";
  updateModeUI();
  renderQuizCard();
  if (mcqEnabled) buildChoices();
});

// è¿›å…¥/é€€å‡ºæµ‹éªŒæ¨¡å¼
el("quiz").addEventListener("click", async () => {
  quizMode = !quizMode;
  quizReveal = false;
  answered = false;
  currentChoices = null;

  // ä»å½“å‰å­¦ä¹ ä½ç½®å¼€å§‹
  quizIdx = activeIdx;

  updateModeUI();
  renderList();

  if (quizMode) {
    renderQuizCard();
    if (mcqEnabled) buildChoices();
    await playThai();
  } else {
    renderStudyCard();
  }
});

// ç†Ÿæ‚‰/é”™é¢˜
el("mark").addEventListener("click", () => markKnown());
el("reset").addEventListener("click", () => resetKnown());

el("wrongOnlyBtn").addEventListener("click", () => {
  wrongOnly = !wrongOnly;
  el("wrongOnlyBtn").textContent = `åªç»ƒé”™é¢˜ï¼š${wrongOnly ? "å¼€" : "å…³"}`;
  if (quizMode) {
    const pool = getQuizPoolIndices();
    quizIdx = pool[0] || 0;
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  }
});

el("clearWrong").addEventListener("click", () => clearWrong());

/** ========== Tests ========== */
function assert(cond, msg) { if (!cond) throw new Error("Test failed: " + msg); }
function runTests() {
  const sample = "Thai,Chinese_Pinyin,TTS_Key\nà¸ªà¸§à¸±à¸ªà¸”à¸µ,ä½ å¥½ nÇ hÇo,zh_cn_0001\n";
  const rows = parseCSV(sample);
  assert(rows.length === 2, "parseCSV should return 2 rows incl header");

  const s = splitZhPy("ä½ å¥½ nÇ hÇo");
  assert(s.zh === "ä½ å¥½", "splitZhPy zh part");
  assert(s.py.includes("nÇ"), "splitZhPy py part");

  assert(thAudioPath("zh_cn_0001") === "audio_th/th_0001.mp3", "thAudioPath maps key to th_0001");
  assert(thAudioPath("zh_cn_12") === "audio_th/th_0012.mp3", "thAudioPath pads to 4 digits");
}

/** ========== Init ========== */
(async function init(){
  try {
    runTests();
    statusEl.textContent = "åŠ è½½ä¸­â€¦";
    DATA = await loadCSV();
    if (!DATA.length) throw new Error("CSV empty");
    VIEW = DATA.slice();
    statusEl.textContent = `å·²åŠ è½½ï¼šphrases.csvï¼ˆ${DATA.length}æ¡ï¼‰`;

    updateModeUI();
    el("wrongOnlyBtn").textContent = `åªç»ƒé”™é¢˜ï¼š${wrongOnly ? "å¼€" : "å…³"}`;
    renderList();
    renderStudyCard();
    updateWrongStat();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "é”™è¯¯ï¼šæ— æ³•åŠ è½½";
    alert(
      "åˆå§‹åŒ–å¤±è´¥ã€‚\n" +
      "è¯·æ£€æŸ¥ï¼š\n" +
      "1) phrases.csv ä¸ index2.html åŒä¸€ç›®å½•\n" +
      "2) CSV ç¼–ç ä¸º UTF-8\n" +
      "3) ä½¿ç”¨é™æ€ç½‘ç«™æ–¹å¼æ‰“å¼€ï¼ˆä¸è¦ç”¨ Drive æ–‡æœ¬é¢„è§ˆï¼‰\n\n" +
      "é”™è¯¯ä¿¡æ¯ï¼š" + (e && e.message ? e.message : String(e))
    );
  }
})();
</script>
</body>
</html>
