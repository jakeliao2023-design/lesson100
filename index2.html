<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ (THâ†’ZH)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#fb7185;
      --border:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai","Noto Sans",sans-serif;background:linear-gradient(180deg,#050915 0%,#0b1220 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:380px 1fr}}

    .panel{background:rgba(15,26,48,.7);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .panel .hd{padding:12px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .bd{padding:12px}

    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#081022;color:var(--text);outline:none}
    input[type="text"]::placeholder{color:#64748b}

    .btn{cursor:pointer;border:1px solid var(--border);background:#0a1327;color:var(--text);padding:9px 12px;border-radius:10px;font-weight:600;font-size:13px}
    .btn:hover{border-color:rgba(148,163,184,.4)}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#04110a}
    .btn.secondary{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}
    .btn.danger{background:linear-gradient(90deg,#e11d48,#fb7185);border:none;color:#18040a}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .list{max-height:62vh;overflow:auto}
    .item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
    .item:hover{background:rgba(96,165,250,.08)}
    .item.active{background:rgba(34,197,94,.12)}
    .idx{color:var(--muted);font-variant-numeric:tabular-nums;min-width:38px}
    .th{font-size:15px;line-height:1.4}
    .zh{font-size:14px;color:#c7d2fe;margin-top:3px}

    .card{padding:14px;border-radius:14px;background:rgba(15,26,48,.7);border:1px solid var(--border)}
    .bigTH{font-size:22px;font-weight:800;letter-spacing:.2px}
    .bigZH{margin-top:10px;font-size:20px;font-weight:800}
    .bigPY{margin-top:6px;color:var(--accent2);font-size:15px}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}

    .progress{height:10px;background:#071022;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#16a34a,#22c55e);width:0%}

    .toggle{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .toggle input{transform:scale(1.1)}

    .note{color:var(--muted);font-size:12px;line-height:1.5}
    code{background:#071022;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <h1>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶</h1>
      <span class="pill">ç‚¹å‡»è¯æ¡æ’­æ”¾ Â· TH â†’ ZH<br/>à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</span>
      <span class="pill" id="status">æœªåŠ è½½</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- å·¦ä¾§ï¼šåˆ—è¡¨ -->
    <section class="panel">
      <div class="hd">
        <input id="q" type="text" placeholder="æœç´¢ï¼šæ³°è¯­ / ä¸­æ–‡ / æ‹¼éŸ³â€¦" />
        <button class="btn tight" id="clear">æ¸…ç©º</button>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px"><button class="btn" id="quiz">ğŸ§ å¬éŸ³é€‰å¥<br/>à¹à¸šà¸šà¸à¸¶à¸à¸«à¸±à¸”à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</button>
          <button class="btn secondary" id="shuffle">éšæœº</button>
          <button class="btn" id="prev">ä¸Šä¸€æ¡</button>
          <button class="btn" id="next">ä¸‹ä¸€æ¡</button>
        </div>
        <div class="progress" title="å­¦ä¹ è¿›åº¦ï¼ˆå·²æ ‡è®°ç†Ÿæ‚‰ï¼‰"><div class="bar" id="bar"></div></div>
        <div class="meta" style="margin:10px 0 0">
          <span id="count">0 æ¡</span>
          <span id="knownCount">å·²ç†Ÿæ‚‰ 0</span>
          <span class="toggle"><input type="checkbox" id="auto" /> è‡ªåŠ¨ä¸‹ä¸€æ¡</span>
          <span class="toggle"><input type="checkbox" id="loop" /> å¾ªç¯æ’­æ”¾</span>
        </div>
      </div>
      <div class="list" id="list"></div>
    </section>

    <!-- å³ä¾§ï¼šå¤§å¡ç‰‡ -->
    <section class="panel">
      <div class="hd">
        <button class="btn primary" id="play">â–¶ æ’­æ”¾</button>
        <button class="btn" id="replay">âŸ² é‡æ’­</button>
        <button class="btn" id="mark">âœ“ æ ‡è®°ç†Ÿæ‚‰</button>
        <button class="btn danger" id="reset">é‡ç½®ç†Ÿæ‚‰</button>
      </div>
      <div class="bd">
        <div class="card">
          <div class="bigTH" id="bigTH">â€”</div>
          <div class="bigZH" id="bigZH">â€”</div>
          <div class="bigPY" id="bigPY">â€”</div>
          <div class="meta">
            <span>éŸ³é¢‘ keyï¼š<code id="key">â€”</code></span>
            <span>æ–‡ä»¶ï¼š<code id="file">â€”</code></span>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="note"><b>å­¦ä¹ æ¨¡å¼è¯´æ˜ / à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¹‚à¸«à¸¡à¸”à¸à¸²à¸£à¹€à¸£à¸µà¸¢à¸™:</b><br/>â€¢ æ™®é€šæ¨¡å¼ï¼šç‚¹å‡»å¥å­å¬éŸ³å­¦ä¹ <br/>â€¢ å¬éŸ³é€‰å¥ï¼šå…ˆå¬å£°éŸ³ï¼Œå†é€‰æ‹©æ­£ç¡®çš„å¥å­<br/><br/>
          <b>æ”¾åˆ° Google Drive çš„æœ€ç¨³æ–¹å¼ï¼š</b><br/>
          1) æ–°å»ºæ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚ <code>lesson100</code><br/>
          2) æ”¾å…¥æœ¬æ–‡ä»¶ <code>index.html</code>ï¼Œå†å»ºå­æ–‡ä»¶å¤¹ <code>audio/</code> æ”¾ <code>zh_cn_0001.mp3 ... zh_cn_0100.mp3</code><br/>
          3) åŒç›®å½•æ”¾ä¸€ä¸ª <code>phrases.csv</code>ï¼ˆæ¨èï¼‰æˆ–ç›´æ¥ç”¨å†…ç½® 100 å¥æ•°æ®<br/>
          <br/>
          <b>CSV æ ¼å¼ï¼ˆæ¨è 3 åˆ—ï¼‰ï¼š</b> <code>Thai,Chinese_Pinyin,TTS_Key</code><br/>
          ä¾‹å¦‚ï¼š<code>à¸ªà¸§à¸±à¸ªà¸”à¸µ,ä½ å¥½ nÇ hÇo,zh_cn_0001</code><br/>
          <br/>
          æœ¬è¯¾ä»¶ä¼˜å…ˆè¯»å– <code>phrases.csv</code>ï¼ˆä½ æ›´æ–° CSV å°±èƒ½æ›´æ–°è¯¾ä»¶ï¼‰ï¼›è¯»å–å¤±è´¥åˆ™ä½¿ç”¨å†…ç½®ç¤ºä¾‹æ•°æ®ã€‚
        </div>
      </div>
    </section>

  </div>
</main>

<audio id="audio" preload="auto"></audio>

<script>
  // =========================
  // 1) å†…ç½®æ•°æ®ï¼ˆå…œåº•ç”¨ï¼‰
  //    å¦‚æœä½ åŒç›®å½•æ”¾äº† phrases.csvï¼Œä¼šä¼˜å…ˆè¯»å– CSV
  // =========================
  const BUILTIN = [
    ["à¸ªà¸§à¸±à¸ªà¸”à¸µ","ä½ å¥½ nÇ hÇo","zh_cn_0001"],
    ["à¸ªà¸šà¸²à¸¢à¸”à¸µà¹„à¸«à¸¡","ä½ å¥½å— nÇ hÇo ma","zh_cn_0002"],
    ["à¸ªà¸§à¸±à¸ªà¸”à¸µà¸•à¸­à¸™à¹€à¸Šà¹‰à¸²","æ—©ä¸Šå¥½ zÇo shang hÇo","zh_cn_0003"],
    ["à¸ªà¸§à¸±à¸ªà¸”à¸µà¸•à¸­à¸™à¹€à¸¢à¹‡à¸™","æ™šä¸Šå¥½ wÇn shang hÇo","zh_cn_0004"],
    ["à¸¥à¸²à¸à¹ˆà¸­à¸™","å†è§ zÃ i jiÃ n","zh_cn_0005"],
    ["à¸‚à¸­à¸šà¸„à¸¸à¸“","è°¢è°¢ xiÃ¨ xie","zh_cn_0006"],
    ["à¸‚à¸­à¸šà¸„à¸¸à¸“à¸¡à¸²à¸","éå¸¸æ„Ÿè°¢ fÄ“i chÃ¡ng gÇn xiÃ¨","zh_cn_0007"],
    ["à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£","ä¸å®¢æ°” bÃº kÃ¨ qi","zh_cn_0008"],
    ["à¸‚à¸­à¹‚à¸—à¸©","å¯¹ä¸èµ· duÃ¬ bÃ¹ qÇ","zh_cn_0009"],
    ["à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£","æ²¡å…³ç³» mÃ©i guÄn xi","zh_cn_0010"],

    ["à¹ƒà¸Šà¹ˆ","æ˜¯çš„ shÃ¬ de","zh_cn_0011"],
    ["à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ","ä¸æ˜¯ bÃº shÃ¬","zh_cn_0012"],
    ["à¹„à¸”à¹‰","å¯ä»¥ kÄ› yÇ","zh_cn_0013"],
    ["à¹„à¸¡à¹ˆà¹„à¸”à¹‰","ä¸å¯ä»¥ bÃ¹ kÄ› yÇ","zh_cn_0014"],
    ["à¸•à¸à¸¥à¸‡","å¥½ hÇo","zh_cn_0015"],
    ["à¹‚à¸­à¹€à¸„","å¥½çš„ hÇo de","zh_cn_0016"],

    ["à¸‰à¸±à¸™à¹„à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¹ƒà¸ˆ","æˆ‘ä¸æ‡‚ wÇ’ bÃ¹ dÇ’ng","zh_cn_0017"],
    ["à¸‰à¸±à¸™à¹€à¸‚à¹‰à¸²à¹ƒà¸ˆà¹à¸¥à¹‰à¸§","æˆ‘æ‡‚äº† wÇ’ dÇ’ng le","zh_cn_0018"],
    ["à¸à¸¹à¸”à¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡à¹„à¸”à¹‰à¹„à¸«à¸¡","è¯·å†è¯´ä¸€é qÇng zÃ i shuÅ yÃ­ biÃ n","zh_cn_0019"],
    ["à¸à¸¹à¸”à¸Šà¹‰à¸²à¹†à¸«à¸™à¹ˆà¸­à¸¢","è¯·è¯´æ…¢ä¸€ç‚¹ qÇng shuÅ mÃ n yÃ¬ diÇn","zh_cn_0020"],
    ["à¸à¸¹à¸”à¸ à¸²à¸©à¸²à¹„à¸—à¸¢à¹„à¸”à¹‰à¹„à¸«à¸¡","ä½ ä¼šè¯´æ³°è¯­å— nÇ huÃ¬ shuÅ tÃ i yÇ” ma","zh_cn_0021"],
    ["à¸‰à¸±à¸™à¸à¸¹à¸”à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™à¹„à¸¡à¹ˆà¹„à¸”à¹‰","æˆ‘ä¸ä¼šè¯´ä¸­æ–‡ wÇ’ bÃº huÃ¬ shuÅ zhÅng wÃ©n","zh_cn_0022"],

    ["à¸„à¸¸à¸“à¸Šà¸·à¹ˆà¸­à¸­à¸°à¹„à¸£","ä½ å«ä»€ä¹ˆåå­— nÇ jiÃ o shÃ©n me mÃ­ng zÃ¬","zh_cn_0023"],
    ["à¸‰à¸±à¸™à¸Šà¸·à¹ˆà¸­â€¦","æˆ‘å«â€¦â€¦ wÇ’ jiÃ o","zh_cn_0024"],
    ["à¸¢à¸´à¸™à¸”à¸µà¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸¹à¹‰à¸ˆà¸±à¸","å¾ˆé«˜å…´è®¤è¯†ä½  hÄ›n gÄo xÃ¬ng rÃ¨n shi nÇ","zh_cn_0025"],
    ["à¸„à¸¸à¸“à¸¡à¸²à¸ˆà¸²à¸à¹„à¸«à¸™","ä½ ä»å“ªé‡Œæ¥ nÇ cÃ³ng nÇ lÇ lÃ¡i","zh_cn_0026"],
    ["à¸‰à¸±à¸™à¸¡à¸²à¸ˆà¸²à¸à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢","æˆ‘æ¥è‡ªæ³°å›½ wÇ’ lÃ¡i zÃ¬ tÃ i guÃ³","zh_cn_0027"],
    ["à¸„à¸¸à¸“à¸­à¸²à¸¢à¸¸à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ","ä½ å¤šå¤§äº† nÇ duÅ dÃ  le","zh_cn_0028"],

    ["à¸§à¸±à¸™à¸™à¸µà¹‰","ä»Šå¤© jÄ«n tiÄn","zh_cn_0029"],
    ["à¸à¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰","æ˜å¤© mÃ­ng tiÄn","zh_cn_0030"],
    ["à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™","æ˜¨å¤© zuÃ³ tiÄn","zh_cn_0031"],
    ["à¸•à¸­à¸™à¸™à¸µà¹‰","ç°åœ¨ xiÃ n zÃ i","zh_cn_0032"],
    ["à¸à¸µà¹ˆà¹‚à¸¡à¸‡à¹à¸¥à¹‰à¸§","ç°åœ¨å‡ ç‚¹ xiÃ n zÃ i jÇ diÇn","zh_cn_0033"],

    ["à¸£à¸²à¸„à¸²à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ","å¤šå°‘é’± duÅ shÇo qiÃ¡n","zh_cn_0034"],
    ["à¹à¸à¸‡à¹„à¸›","å¤ªè´µäº† tÃ i guÃ¬ le","zh_cn_0035"],
    ["à¸–à¸¹à¸à¸¡à¸²à¸","å¾ˆä¾¿å®œ hÄ›n piÃ¡n yi","zh_cn_0036"],
    ["à¸¥à¸”à¹„à¸”à¹‰à¹„à¸«à¸¡","å¯ä»¥ä¾¿å®œä¸€ç‚¹å— kÄ› yÇ piÃ¡n yi yÃ¬ diÇn ma","zh_cn_0037"],
    ["à¸‰à¸±à¸™à¸­à¸¢à¸²à¸à¸‹à¸·à¹‰à¸­","æˆ‘è¦ä¹° wÇ’ yÃ o mÇi","zh_cn_0038"],
    ["à¸‰à¸±à¸™à¹„à¸¡à¹ˆà¸­à¸¢à¸²à¸à¸‹à¸·à¹‰à¸­","æˆ‘ä¸è¦ wÇ’ bÃº yÃ o","zh_cn_0039"],

    ["à¸‰à¸±à¸™à¸«à¸´à¸§","æˆ‘é¥¿äº† wÇ’ Ã¨ le","zh_cn_0040"],
    ["à¸‰à¸±à¸™à¸­à¸´à¹ˆà¸¡à¹à¸¥à¹‰à¸§","æˆ‘é¥±äº† wÇ’ bÇo le","zh_cn_0041"],
    ["à¸‰à¸±à¸™à¸­à¸¢à¸²à¸à¸à¸´à¸™à¸‚à¹‰à¸²à¸§","æˆ‘æƒ³åƒé¥­ wÇ’ xiÇng chÄ« fÃ n","zh_cn_0042"],
    ["à¸‚à¸­à¹€à¸¡à¸™à¸¹à¸«à¸™à¹ˆà¸­à¸¢","è¯·ç»™æˆ‘èœå• qÇng gÄ›i wÇ’ cÃ i dÄn","zh_cn_0043"],
    ["à¸­à¸£à¹ˆà¸­à¸¢à¸¡à¸²à¸","å¾ˆå¥½åƒ hÄ›n hÇo chÄ«","zh_cn_0044"],
    ["à¹„à¸¡à¹ˆà¸­à¸£à¹ˆà¸­à¸¢","ä¸å¥½åƒ bÃ¹ hÇo chÄ«","zh_cn_0045"],

    ["à¹„à¸›à¸—à¸²à¸‡à¹„à¸«à¸™","æ€ä¹ˆèµ° zÄ›n me zÇ’u","zh_cn_0046"],
    ["à¹€à¸¥à¸µà¹‰à¸¢à¸§à¸‹à¹‰à¸²à¸¢","å·¦è½¬ zuÇ’ zhuÇn","zh_cn_0047"],
    ["à¹€à¸¥à¸µà¹‰à¸¢à¸§à¸‚à¸§à¸²","å³è½¬ yÃ²u zhuÇn","zh_cn_0048"],
    ["à¹€à¸”à¸´à¸™à¸•à¸£à¸‡à¹„à¸›","ä¸€ç›´èµ° yÃ¬ zhÃ­ zÇ’u","zh_cn_0049"],
    ["à¸–à¸¶à¸‡à¹à¸¥à¹‰à¸§","åˆ°äº† dÃ o le","zh_cn_0050"],

    // ä½ æ”¾ phrases.csv åï¼Œå†…ç½®æ•°æ®ä¸ä¼šå½±å“ï¼›è¿™é‡Œåªåšç¤ºä¾‹å…œåº•ã€‚
  ];

  // =========================
  // 2) è¯»å– CSVï¼ˆåŒç›®å½• phrases.csvï¼‰
  //    æ ¼å¼ï¼šThai,Chinese_Pinyin,TTS_Key
  // =========================
  async function loadCSV() {
    const res = await fetch("phrases.csv", { cache: "no-store" });
    if (!res.ok) throw new Error("phrases.csv not found");
    const text = await res.text();
    const rows = parseCSV(text);

    // å»æ‰è¡¨å¤´ï¼ˆå¦‚æœç¬¬ä¸€è¡Œå« Thai / Chinese ç­‰ï¼‰
    const cleaned = rows.filter(r => r.join(" ").trim().length);
    const head = cleaned[0]?.map(x => (x||"").toLowerCase()) || [];
    const hasHeader = head.includes("thai") || head.includes("chinese_pinyin") || head.includes("tts_key");
    const dataRows = hasHeader ? cleaned.slice(1) : cleaned;

    const out = [];
    for (let i = 0; i < dataRows.length; i++) {
      const r = dataRows[i];
      const thai = (r[0] || "").trim();
      const zhpy = (r[1] || "").trim();
      const key = (r[2] || "").trim() || `zh_cn_${String(i+1).padStart(4, "0")}`;
      if (!thai || !zhpy) continue;
      out.push([thai, zhpy, key]);
    }
    return out;
  }

  // è½»é‡ CSV parserï¼ˆæ”¯æŒå¼•å·/é€—å·ï¼‰
  function parseCSV(csv) {
    const lines = csv.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
    const rows = [];
    for (const line of lines) {
      if (!line.trim()) continue;
      const row = [];
      let cur = "";
      let inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; }
          else inQ = !inQ;
        } else if (ch === ',' && !inQ) {
          row.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      row.push(cur);
      rows.push(row.map(s => (s||"").trim()));
    }
    return rows;
  }

  // =========================
  // 3) UI é€»è¾‘
  // =========================
  const el = (id) => document.getElementById(id);
  const listEl = el("list");
  const qEl = el("q");
  const statusEl = el("status");

  const bigTH = el("bigTH");
  const bigZH = el("bigZH");
  const bigPY = el("bigPY");
  const keyEl = el("key");
  const fileEl = el("file");
  const barEl = el("bar");
  const countEl = el("count");
  const knownCountEl = el("knownCount");

  const audio = el("audio");
  const autoNext = el("auto");
  let quizMode = false;
  let quizAnswer = null;
  const loopPlay = el("loop");

  let DATA = [];
  let VIEW = [];
  let activeIdx = 0;

  const KNOWN_KEY = "lesson100_known_v1";
  const known = new Set(JSON.parse(localStorage.getItem(KNOWN_KEY) || "[]"));

  function splitZhPy(zhpy) {
    // è§„åˆ™ï¼šä¸­æ–‡åœ¨å‰ï¼Œæ‹¼éŸ³åœ¨åï¼ˆä¸­é—´è‡³å°‘ä¸€ä¸ªç©ºæ ¼ï¼‰
    // è‹¥æ²¡æœ‰ç©ºæ ¼ï¼Œå°±å½“ä½œå…¨ä¸­æ–‡
    const m = zhpy.match(/^(.*?)(\s+[a-zA-ZÄÃ¡ÇÃ Ä“Ã©Ä›Ã¨Ä«Ã­ÇÃ¬ÅÃ³Ç’Ã²Å«ÃºÇ”Ã¹Ç–Ç˜ÇšÇœ\s]+.*)$/);
    if (!m) return { zh: zhpy, py: "" };
    return { zh: m[1].trim(), py: m[2].trim() };
  }

  function audioPath(key) {
    return `audio/${key}.mp3`; // ä½ å¦‚æœç”¨ wav/aacï¼Œæ”¹è¿™é‡Œ
  }

  function renderList() {
    listEl.innerHTML = "";
    const quizOptions = quizMode && quizAnswer ? shuffleArray(VIEW.slice()).slice(0,4).map(x=>x[2]).includes(quizAnswer[2]) ? shuffleArray(VIEW.slice()).slice(0,4) : shuffleArray(VIEW.slice()).slice(0,3).concat([quizAnswer]) : null;
    listEl.innerHTML = "";
    VIEW.forEach((it, i) => {
      const [thai, zhpy, key] = it;
      if (quizMode && quizOptions && !quizOptions.find(x=>x[2]===key)) return;
      const div = document.createElement("div");
      div.className = "item" + (i === activeIdx ? " active" : "");
      div.dataset.i = String(i);

      const idx = document.createElement("div");
      idx.className = "idx";
      idx.textContent = String(i + 1).padStart(3, "0");

      const body = document.createElement("div");
      const th = document.createElement("div");
      th.className = "th";
      th.textContent = thai + (known.has(key) ? "  âœ“" : "");
      const zh = document.createElement("div");
      zh.className = "zh";
      zh.textContent = zhpy;

      body.appendChild(th);
      body.appendChild(zh);

      div.appendChild(idx);
      div.appendChild(body);
      div.addEventListener("click", () => {
        if(quizMode){
          if(key===quizAnswer[2]){
            alert('âœ… æ­£ç¡® / à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
          }else{
            alert('âŒ é”™è¯¯ / à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡');
          }
          quizMode=false;
          applyFilter();
        }else{
          select(i, true);
        }
      });
      listEl.appendChild(div);
    });

    countEl.textContent = `${VIEW.length} æ¡`;
    updateProgress();
  }

  function updateProgress() {
    const total = VIEW.length || 1;
    const knownCount = VIEW.filter(([, , key]) => known.has(key)).length;
    knownCountEl.textContent = `å·²ç†Ÿæ‚‰ ${knownCount}`;
    barEl.style.width = `${Math.round((knownCount / total) * 100)}%`;
  }

  function select(i, scrollIntoView) {
    if (i < 0 || i >= VIEW.length) return;
    activeIdx = i;

    // update highlight
    [...listEl.querySelectorAll(".item")].forEach((node, idx) => {
      node.classList.toggle("active", idx === activeIdx);
    });

    const [thai, zhpy, key] = VIEW[activeIdx];
    const { zh, py } = splitZhPy(zhpy);
    bigTH.textContent = thai;
    bigZH.textContent = zh;
    bigPY.textContent = py;
    keyEl.textContent = key;
    fileEl.textContent = audioPath(key);

    if (scrollIntoView) {
      const node = listEl.querySelector(`.item[data-i="${activeIdx}"]`);
      node?.scrollIntoView({ block: "nearest" });
    }
  }

  async function playByKey(key){
    audio.loop = false;
    audio.src = audioPath(key);
    await audio.play();
  }

  async function playCurrent() {
    const [, , key] = VIEW[activeIdx] || [];
    if (!key) return;
    audio.loop = loopPlay.checked;
    audio.src = audioPath(key);
    try {
      await audio.play();
    } catch (e) {
      alert("æ— æ³•æ’­æ”¾éŸ³é¢‘ã€‚è¯·ç¡®è®¤ï¼š1) audio/ ä¸‹å­˜åœ¨å¯¹åº” mp3ï¼›2) æ‰‹æœºæµè§ˆå™¨éœ€è¦å…ˆç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘ã€‚");
    }
  }

  function next() {
    if (!VIEW.length) return;
    select((activeIdx + 1) % VIEW.length, true);
  }
  function prev() {
    if (!VIEW.length) return;
    select((activeIdx - 1 + VIEW.length) % VIEW.length, true);
  }

  function shuffle() {
    if (!VIEW.length) return;
    const curKey = VIEW[activeIdx]?.[2];
    VIEW = VIEW.slice().sort(() => Math.random() - 0.5);
    renderList();
    const newIdx = VIEW.findIndex((x) => x[2] === curKey);
    select(newIdx >= 0 ? newIdx : 0, true);
  }

  function applyFilter() {
    const q = (qEl.value || "").trim().toLowerCase();
    if (!q) {
      VIEW = DATA.slice();
    } else {
      VIEW = DATA.filter(([thai, zhpy, key]) =>
        thai.toLowerCase().includes(q) ||
        zhpy.toLowerCase().includes(q) ||
        key.toLowerCase().includes(q)
      );
    }
    activeIdx = 0;
    renderList();
    select(0, false);
  }

  function markKnown() {
    const [, , key] = VIEW[activeIdx] || [];
    if (!key) return;
    if (known.has(key)) known.delete(key); else known.add(key);
    localStorage.setItem(KNOWN_KEY, JSON.stringify([...known]));
    renderList();
    select(activeIdx, false);
  }

  function resetKnown() {
    if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰â€œå·²ç†Ÿæ‚‰â€æ ‡è®°å—ï¼Ÿ")) return;
    known.clear();
    localStorage.setItem(KNOWN_KEY, "[]");
    renderList();
    select(activeIdx, false);
  }

  // è‡ªåŠ¨ä¸‹ä¸€æ¡ï¼šæ’­æ”¾ç»“æŸåè·³åˆ°ä¸‹ä¸€æ¡å¹¶æ’­æ”¾
  audio.addEventListener("ended", async () => {
    if (!autoNext.checked) return;
    next();
    // æ‰‹æœºä¸Šéœ€è¦ç”¨æˆ·æ‰‹åŠ¿è§£é”ï¼šç¬¬ä¸€æ¬¡è¯·æ‰‹åŠ¨ç‚¹â€œæ’­æ”¾â€
    await playCurrent();
  });

  // ç»‘å®šæŒ‰é’®
  el("play").addEventListener("click", () => playCurrent());
  el("replay").addEventListener("click", () => playCurrent());
  el("next").addEventListener("click", () => next());
  el("prev").addEventListener("click", () => prev());
  el("quiz").addEventListener("click", async () => {
    quizMode = true;
    quizAnswer = VIEW[Math.floor(Math.random()*VIEW.length)];
    await playByKey(quizAnswer[2]);
    renderList();
  });

  el("shuffle").addEventListener("click", () => shuffle());
  el("mark").addEventListener("click", () => markKnown());
  el("reset").addEventListener("click", () => resetKnown());
  el("clear").addEventListener("click", () => { qEl.value = ""; applyFilter(); });
  qEl.addEventListener("input", () => applyFilter());

  // åˆå§‹åŒ–åŠ è½½ï¼šä¼˜å…ˆ phrases.csv
  (async function init(){
    try {
      statusEl.textContent = "åŠ è½½ä¸­â€¦";
      const csvData = await loadCSV();
      DATA = csvData.length ? csvData : BUILTIN;
      statusEl.textContent = csvData.length ? "å·²åŠ è½½ï¼šphrases.csv" : "å·²åŠ è½½ï¼šå†…ç½®æ•°æ®";
    } catch (e) {
      DATA = BUILTIN;
      statusEl.textContent = "å·²åŠ è½½ï¼šå†…ç½®æ•°æ®";
    }

    VIEW = DATA.slice();
    renderList();
    select(0, false);
  })();
</script>
</body>
</html>
