<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#fb7185;
      --border:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai","Noto Sans",sans-serif;background:linear-gradient(180deg,#050915 0%,#0b1220 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:380px 1fr}}

    @media(max-width:699px){
      :root{ --tap:44px; }
      .wrap{padding:12px}
      header .wrap{padding:10px 12px}
      h1{font-size:16px;line-height:1.2}
      .pill{font-size:11px}

      /* single column; panels become â€œpagesâ€ via tabs */
      .grid{gap:10px}
      .panel{border-radius:16px}
      .panel .hd{padding:10px;gap:8px}
      .panel .bd{padding:10px}

      /* Buttons: larger tap targets */
      .btn{min-height:var(--tap);padding:10px 12px;font-size:13px;border-radius:14px}
      input[type="text"]{min-height:var(--tap);border-radius:14px}

      /* List fills viewport (minus header & bottom tabs) */
      main.wrap{padding-bottom:calc(84px + env(safe-area-inset-bottom))}
      .list{max-height:none;height:calc(100dvh - 260px);border-radius:14px}

      /* Card area scroll-friendly */
      #cardPanel .bd{max-height:calc(100dvh - 220px);overflow:auto;-webkit-overflow-scrolling:touch}

      /* MCQ buttons comfy */
      .choices{gap:10px}
      .choiceBtn{min-height:var(--tap);border-radius:14px;white-space:normal;line-height:1.25}

      /* Top controls wrap nicely */
      .row{gap:8px}
      .row > *{flex:1 1 48%}
      .row .tight{flex:1 1 auto}

      .mobile-nav{display:flex}
    }

    .mobile-nav{
      display:none;
      position:fixed;left:0;right:0;bottom:0;
      padding:10px 12px;
      background:rgba(11,18,32,.92);
      backdrop-filter:blur(10px);
      border-top:1px solid var(--border);
      z-index:60;
      gap:10px;
    }
    .seg{flex:1;display:flex;gap:8px}
    .seg button{flex:1}
    .seg .active{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}

    .panel{background:rgba(15,26,48,.7);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .panel .hd{padding:12px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .bd{padding:12px}

    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#081022;color:var(--text);outline:none}
    input[type="text"]::placeholder{color:#64748b}

    .btn{cursor:pointer;border:1px solid var(--border);background:#0a1327;color:var(--text);padding:9px 12px;border-radius:10px;font-weight:600;font-size:13px}
    .btn:hover{border-color:rgba(148,163,184,.4)}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#04110a}
    .btn.secondary{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}
    .btn.danger{background:linear-gradient(90deg,#e11d48,#fb7185);border:none;color:#18040a}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .list{max-height:62vh;overflow:auto}
    .item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
    .item:hover{background:rgba(96,165,250,.08)}
    .item.active{background:rgba(34,197,94,.12)}
    .idx{color:var(--muted);font-variant-numeric:tabular-nums;min-width:38px}
    .th{font-size:15px;line-height:1.4}
    .zh{font-size:14px;color:#c7d2fe;margin-top:3px}

    .card{padding:14px;border-radius:14px;background:rgba(15,26,48,.7);border:1px solid var(--border)}
    .bigTH{font-size:22px;font-weight:800;letter-spacing:.2px}
    .bigZH{margin-top:10px;font-size:20px;font-weight:800}
    .bigPY{margin-top:6px;color:var(--accent2);font-size:15px}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}

    .progress{height:10px;background:#071022;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#16a34a,#22c55e);width:0%}

    .toggle{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .toggle input{transform:scale(1.1)}

    .note{color:var(--muted);font-size:12px;line-height:1.5}
    code{background:#071022;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
    .warn{color:#fbbf24}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(8,16,34,.6);color:var(--muted);font-size:12px}

    /* MCQ */
    .choices{display:flex;flex-direction:column;gap:10px}
    .choiceBtn{width:100%;text-align:left}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <h1>
        ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰
        <br/><span style="font-size:13px;color:#94a3b8">à¸šà¸—à¹€à¸£à¸µà¸¢à¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™ 100 à¸›à¸£à¸°à¹‚à¸¢à¸„ (à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡)</span>
      </h1>
      <span class="pill">æ™®é€šï¼šç‚¹åˆ—è¡¨æ’­ä¸­æ–‡ï½œæµ‹éªŒï¼šé¢˜ç›®=æ³°è¯­+æ³°è¯­éŸ³é¢‘ï¼›ç­”æ¡ˆ=ä¸­æ–‡+æ‹¼éŸ³ï¼ˆå››é€‰ä¸€ï¼‰</span>
      <span class="pill" id="status">æœªåŠ è½½</span>
      <span class="pill" id="csvWhere" style="display:none">CSVï¼šâ€”</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- å·¦ä¾§ï¼šåˆ—è¡¨ -->
    <section class="panel" id="listPanel">
      <div class="hd">
        <input id="q" type="text" placeholder="æœç´¢ï¼šæ³°è¯­ / ä¸­æ–‡ / æ‹¼éŸ³ / key â€¦" />
        <button class="btn tight" id="clear">æ¸…ç©º</button>
      </div>
      <div class="bd" style="padding-top:10px">
        <div class="row" style="margin-bottom:10px">
          <input id="csvUrl" type="text" placeholder="CSV åœ°å€ï¼ˆå¯é€‰ï¼‰ï¼šä¾‹å¦‚ ./phrases.csv æˆ– https://.../phrases.csv" />
          <button class="btn tight secondary" id="loadCsvBtn">åŠ è½½CSV</button>
        </div>
        <div class="row" style="margin-bottom:10px">
          <input id="csvFile" type="file" accept=".csv,text/csv" />
          <button class="btn tight" id="useFileBtn">ç”¨æœ¬åœ°CSV</button>
        </div>
        <div class="note" style="margin:-2px 0 10px">
          æ‰‹æœº/å¹³æ¿å¦‚æœå‡ºç°â€œæ— æ³•åŠ è½½CSVâ€ï¼šé€šå¸¸æ˜¯ <code>phrases.csv</code> è·¯å¾„ä¸å¯¹æˆ–é¡µé¢ä¸æ˜¯é€šè¿‡ç½‘ç«™æ–¹å¼æ‰“å¼€ï¼ˆä¸è¦ç”¨ <code>file://</code>ï¼‰ã€‚
        </div>
      </div>
      <div class="bd" style="padding-top:0">
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <button class="btn" id="quiz">ğŸ§ å¬éŸ³é—®ç­”<br/>à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸šà¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</button>
          <button class="btn secondary" id="shuffle">éšæœº</button>
          <button class="btn" id="prev">ä¸Šä¸€æ¡</button>
          <button class="btn" id="next">ä¸‹ä¸€æ¡</button>
        </div>
        <div class="progress" title="å­¦ä¹ è¿›åº¦ï¼ˆå·²æ ‡è®°ç†Ÿæ‚‰ï¼‰"><div class="bar" id="bar"></div></div>
        <div class="meta" style="margin:10px 0 0">
          <span id="count">0 æ¡</span>
          <span id="knownCount">å·²ç†Ÿæ‚‰ 0</span>
          <span class="toggle"><input type="checkbox" id="auto" /> è‡ªåŠ¨ä¸‹ä¸€æ¡</span>
          <span class="toggle"><input type="checkbox" id="loop" /> å¾ªç¯æ’­æ”¾</span>
          <span class="badge" id="mode">æ™®é€šæ¨¡å¼</span>
        </div>
      </div>
      <div class="list" id="list"></div>
    </section>

    <!-- å³ä¾§ï¼šå¡ç‰‡ -->
    <section class="panel" id="cardPanel">
      <div class="hd">
        <button class="btn primary" id="playTh">â–¶ æ’­æ”¾æ³°è¯­<br/>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</button>
        <button class="btn" id="replay">âŸ² é‡æ’­</button>
        <button class="btn secondary" id="showAns">ğŸ‘ æ˜¾ç¤ºç­”æ¡ˆ<br/>à¸”à¸¹à¸„à¸³à¸•à¸­à¸š</button>
        <button class="btn secondary" id="mcqMode">ğŸ…°ğŸ…± é€‰æ‹©é¢˜<br/>à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸</button>
        <button class="btn" id="playZh">â–¶ æ’­æ”¾ä¸­æ–‡<br/>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™</button>
        <button class="btn" id="prevQ">â—€ ä¸Šä¸€é¢˜<br/>à¸à¹ˆà¸­à¸™à¸«à¸™à¹‰à¸²</button>
        <button class="btn" id="nextQ">ä¸‹ä¸€é¢˜ â–¶<br/>à¸–à¸±à¸”à¹„à¸›</button>
        <button class="btn" id="mark">âœ“ æ ‡è®°ç†Ÿæ‚‰</button>
        <button class="btn danger" id="reset">é‡ç½®ç†Ÿæ‚‰</button>
      </div>
      <div class="bd">
        <div class="card">
          <div class="bigTH" id="bigTH">â€”</div>
          <div class="bigZH" id="bigZH">â€”</div>
          <div class="bigPY" id="bigPY">â€”</div>
          <div class="meta">
            <span>éŸ³é¢‘ keyï¼š<code id="key">â€”</code></span>
            <span>æ–‡ä»¶ï¼š<code id="file">â€”</code></span>
            <span>é”™é¢˜ï¼š<code id="wrongStat">0é¢˜/0æ¬¡</code></span>
          </div>
        </div>

        <div style="height:12px"></div>

        <!-- âœ… é€‰æ‹©é¢˜ï¼ˆå››é€‰ä¸€ï¼‰åŒºåŸŸï¼šåªåœ¨æµ‹éªŒæ¨¡å¼æ˜¾ç¤º -->
        <div class="card" id="mcq" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div style="font-weight:800">é€‰æ‹©é¢˜ï¼ˆå››é€‰ä¸€ï¼‰<span style="font-weight:600;color:#94a3b8">ï½œà¸„à¸³à¸–à¸²à¸¡à¹à¸šà¸šà¹€à¸¥à¸·à¸­à¸à¸•à¸­à¸š</span></div>
            <div class="row" style="margin:0">
              <button class="btn tight" id="wrongOnlyBtn">åªç»ƒé”™é¢˜ï¼šå…³</button>
              <button class="btn danger tight" id="clearWrong">æ¸…ç©ºé”™é¢˜</button>
            </div>
          </div>
          <div style="height:10px"></div>
          <div id="choices" class="choices"></div>
          <div style="height:10px"></div>
          <div class="note" id="mcqHint">ç‚¹å‡»é€‰é¡¹ä½œç­”ã€‚ç­”å®Œä¼šæ˜¾ç¤ºæ­£è¯¯ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚</div>
        </div>

        <div style="height:12px"></div>

        <div class="note">
          <b>æ–‡ä»¶ç»“æ„ï¼ˆåŒä¸€æ–‡ä»¶å¤¹ï¼‰:</b><br/>
          <code>index.html</code>ï¼ˆæœ¬æ–‡ä»¶ï¼‰<br/>
          <code>phrases.csv</code>ï¼ˆ3åˆ—ï¼šThai,Chinese_Pinyin,TTS_Keyï¼‰<br/>
          <code>audio/</code>ï¼ˆä¸­æ–‡éŸ³é¢‘ï¼‰<code>&lt;key&gt;.mp3</code>ï¼ˆä¾‹ <code>audio/zh_cn_0001.mp3</code>ï¼‰<br/>
          <code>audio_th/</code>ï¼ˆæ³°è¯­éŸ³é¢‘ï¼‰<code>th_0001.mp3</code>ï¼ˆä¾‹ <code>audio_th/th_0001.mp3</code>ï¼‰<br/>
          <br/>
          <b class="warn">æ³¨æ„ï¼š</b>æ‰‹æœºæµè§ˆå™¨é€šå¸¸éœ€è¦å…ˆç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘æƒé™ã€‚
        </div>
      </div>
    </section>

  </div>

  <!-- Mobile bottom nav -->
  <div class="mobile-nav" id="mobileNav">
    <div class="seg">
      <button class="btn" id="tabList">ğŸ“‹ åˆ—è¡¨<br/>à¸£à¸²à¸¢à¸à¸²à¸£</button>
      <button class="btn" id="tabPractice">ğŸ§ ç»ƒä¹ <br/>à¸à¸¶à¸</button>
    </div>
  </div>
</main>

<audio id="audio" preload="auto"></audio>

<script>
"use strict";

// ------------------------------
// Mobile tabs
// ------------------------------
function applyMobileTabs() {
  const isMobile = window.matchMedia("(max-width:699px)").matches;
  const listPanel = document.getElementById("listPanel");
  const cardPanel = document.getElementById("cardPanel");
  const nav = document.getElementById("mobileNav");
  if (!listPanel || !cardPanel || !nav) return;

  if (!isMobile) {
    nav.style.display = "none";
    listPanel.style.display = "";
    cardPanel.style.display = "";
    return;
  }

  // Default to practice tab on mobile
  if (!window.__tab) window.__tab = "practice";

  nav.style.display = "flex";
  listPanel.style.display = (window.__tab === "list") ? "" : "none";
  cardPanel.style.display = (window.__tab === "practice") ? "" : "none";

  const tabList = document.getElementById("tabList");
  const tabPractice = document.getElementById("tabPractice");
  if (tabList && tabPractice) {
    tabList.classList.toggle("active", window.__tab === "list");
    tabPractice.classList.toggle("active", window.__tab === "practice");
  }
}
window.addEventListener("resize", applyMobileTabs);
document.addEventListener("click", (e) => {
  const id = e.target && e.target.id ? e.target.id : "";
  if (id === "tabList") { window.__tab = "list"; applyMobileTabs(); }
  if (id === "tabPractice") { window.__tab = "practice"; applyMobileTabs(); }
});

// ------------------------------
// Helpers
// ------------------------------
const el = (id) => document.getElementById(id);

function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQ = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];

    if (ch === '"') {
      if (inQ && text[i + 1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
      continue;
    }

    if (!inQ && ch === ',') {
      row.push(cur.trim());
      cur = "";
      continue;
    }

    if (!inQ && (ch === '' || ch === '')) {
      if (ch === '' && text[i + 1] === '') i++;
      row.push(cur.trim());
      cur = "";
      if (row.some(x => x !== "")) rows.push(row);
      row = [];
      continue;
    }

    cur += ch;
  }

  row.push(cur.trim());
  if (row.some(x => x !== "")) rows.push(row);
  return rows;
}

async function loadCSV(customUrl){
  const candidates = [];
  if (customUrl && String(customUrl).trim()) candidates.push(String(customUrl).trim());
  candidates.push("./phrases.csv");
  candidates.push("phrases.csv");
  candidates.push("./data/phrases.csv");

  let lastErr = null;
  for (const url of candidates) {
    try {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const text = await res.text();
      let rows = parseCSV(text);

      const head = (rows[0] || []).map(x => (x || "").toLowerCase());
      const hasHeader = head.includes("thai") || head.includes("chinese_pinyin") || head.includes("tts_key");
      if (hasHeader) rows = rows.slice(1);

      const out = [];
      for (const r of rows) {
        const thai = (r[0] || "").trim();
        const zhpy = (r[1] || "").trim();
        const key  = (r[2] || "").trim();
        if (!thai || !zhpy || !key) continue;
        out.push([thai, zhpy, key]);
      }

      if (!out.length) throw new Error("CSV parsed but empty (check columns: Thai,Chinese_Pinyin,TTS_Key)");

      // remember where
      csvWhereEl.style.display = "inline-block";
      csvWhereEl.textContent = "CSVï¼š" + url;
      return out;
    } catch (e) {
      lastErr = { url, err: e };
    }
  }

  const msg = lastErr
    ? `Tried: ${lastErr.url}\n${lastErr.err && lastErr.err.message ? lastErr.err.message : String(lastErr.err)}`
    : "Unknown error";
  throw new Error("æ— æ³•åŠ è½½ CSVã€‚\n" + msg + "\n\næ£€æŸ¥ï¼š1) phrases.csv æ˜¯å¦ä¸ç½‘é¡µåŒç›®å½• 2) æ–‡ä»¶åå¤§å°å†™ä¸€è‡´ 3) ç”¨ GitHub Pages/æœ¬åœ°æœåŠ¡å™¨æ‰“å¼€ï¼Œä¸è¦ file:// 4) CSV ç¼–ç  UTF-8");
}

function splitZhPy(zhpy){
  const s = String(zhpy || "").trim();
  const p = s.lastIndexOf(" ");
  if (p <= 0) return { zh: s, py: "" };
  const zh = s.slice(0, p).trim();
  const py = s.slice(p + 1).trim();
  if (py.length < 2) return { zh: s, py: "" };
  return { zh, py };
}

function zhAudioPath(key){ return "audio/" + key + ".mp3"; }
function thAudioPath(key){
  const parts = String(key).split("_");
  let num = parts[parts.length - 1] || "0001";
  num = String(num).padStart(4, "0");
  return "audio_th/th_" + num + ".mp3";
}

function shuffle(arr){
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    const t = arr[i];
    arr[i] = arr[j];
    arr[j] = t;
  }
  return arr;
}

// ------------------------------
// DOM refs
// ------------------------------
const listEl = el("list");
const qEl = el("q");
const statusEl = el("status");
const csvWhereEl = el("csvWhere");
const modeEl = el("mode");

const bigTH = el("bigTH");
const bigZH = el("bigZH");
const bigPY = el("bigPY");
const keyEl = el("key");
const fileEl = el("file");

const barEl = el("bar");
const countEl = el("count");
const knownCountEl = el("knownCount");

const wrongStatEl = el("wrongStat");
const mcqCard = el("mcq");
const choicesEl = el("choices");
const mcqHintEl = el("mcqHint");

const audio = el("audio");
const autoNext = el("auto");
const loopPlay = el("loop");

// ------------------------------
// State
// ------------------------------
let DATA = [];
let VIEW = [];
let activeIdx = 0;

let quizMode = false;
let quizIdx = 0;

let mcqEnabled = true; // âœ… default ON
let answered = false;
let currentChoices = null; // { correctKey, options }

const KNOWN_KEY = "lesson100_known_v1";
const WRONG_KEY = "lesson100_wrong_v1";

const known = new Set(JSON.parse(localStorage.getItem(KNOWN_KEY) || "[]"));
const wrongMap = JSON.parse(localStorage.getItem(WRONG_KEY) || "{}") || {};
let wrongOnly = false;

function saveKnown(){ localStorage.setItem(KNOWN_KEY, JSON.stringify(Array.from(known))); }
function saveWrong(){ localStorage.setItem(WRONG_KEY, JSON.stringify(wrongMap)); updateWrongStat(); }

function updateWrongStat(){
  const keys = Object.keys(wrongMap);
  let total = 0;
  for (const k of keys) total += Number(wrongMap[k] || 0);
  wrongStatEl.textContent = keys.length + "é¢˜/" + total + "æ¬¡";
}

function getQuizPool(){
  if (!wrongOnly) return VIEW.map((_, i) => i);
  const keys = new Set(Object.keys(wrongMap));
  const idxs = [];
  for (let i = 0; i < VIEW.length; i++) {
    if (keys.has(VIEW[i][2])) idxs.push(i);
  }
  return idxs.length ? idxs : VIEW.map((_, i) => i);
}

function currentKey(){
  const idx = quizMode ? quizIdx : activeIdx;
  return (VIEW[idx] || [])[2] || "";
}

// ------------------------------
// UI
// ------------------------------
function updateModeUI(){
  modeEl.textContent = quizMode ? "æµ‹éªŒæ¨¡å¼" : "æ™®é€šæ¨¡å¼";

  el("showAns").style.display = quizMode ? "inline-block" : "none";
  el("mcqMode").style.display = quizMode ? "inline-block" : "none";
  el("playTh").style.display = quizMode ? "inline-block" : "none";
  el("playZh").style.display = quizMode ? "inline-block" : "none";

  mcqCard.style.display = (quizMode && mcqEnabled) ? "block" : "none";
}

function updateProgress(){
  const total = VIEW.length || 1;
  let kc = 0;
  for (const it of VIEW) if (known.has(it[2])) kc++;
  knownCountEl.textContent = "å·²ç†Ÿæ‚‰ " + kc;
  barEl.style.width = Math.round((kc / total) * 100) + "%";
  updateWrongStat();
}

function renderList(){
  listEl.innerHTML = "";

  for (let i = 0; i < VIEW.length; i++) {
    const [thai, zhpy, key] = VIEW[i];

    const div = document.createElement("div");
    const isActive = quizMode ? (i === quizIdx) : (i === activeIdx);
    div.className = "item" + (isActive ? " active" : "");

    const idx = document.createElement("div");
    idx.className = "idx";
    idx.textContent = String(i + 1).padStart(3, "0");

    const body = document.createElement("div");
    const th = document.createElement("div");
    th.className = "th";
    const wrongTag = wrongMap[key] ? ("  âœ—" + wrongMap[key]) : "";
    th.textContent = thai + (known.has(key) ? "  âœ“" : "") + wrongTag;

    const zh = document.createElement("div");
    zh.className = "zh";
    zh.textContent = zhpy;

    body.appendChild(th);
    body.appendChild(zh);

    div.appendChild(idx);
    div.appendChild(body);

    div.addEventListener("click", async () => {
      if (quizMode) {
        quizIdx = i;
        answered = false;
        currentChoices = null;
        renderList();
        renderQuizCard();
        if (mcqEnabled) buildChoices();
        await playThai();
      } else {
        activeIdx = i;
        renderList();
        renderStudyCard();
        await playChinese();
      }
    });

    listEl.appendChild(div);
  }

  countEl.textContent = VIEW.length + " æ¡";
  updateProgress();
}

function renderStudyCard(){
  if (!VIEW.length) return;
  const [thai, zhpy, key] = VIEW[activeIdx] || VIEW[0];
  const sp = splitZhPy(zhpy);

  bigTH.textContent = thai;
  bigZH.textContent = sp.zh || "â€”";
  bigPY.textContent = sp.py || "";
  keyEl.textContent = key;
  fileEl.textContent = "ZH: " + zhAudioPath(key);
}

function renderQuizCard(){
  if (!VIEW.length) return;
  const [thai, zhpy, key] = VIEW[quizIdx] || VIEW[0];
  const sp = splitZhPy(zhpy);

  bigTH.textContent = "Q" + String(quizIdx + 1).padStart(3, "0") + ". " + thai;
  keyEl.textContent = key;
  fileEl.textContent = "TH: " + thAudioPath(key) + " | ZH: " + zhAudioPath(key);

  if (mcqEnabled) {
    if (answered) {
      bigZH.textContent = sp.zh || "â€”";
      bigPY.textContent = sp.py || "";
    } else {
      bigZH.textContent = "ï¼ˆå››é€‰ä¸€ï¼šè¯·é€‰æ‹©æ­£ç¡®ç­”æ¡ˆï¼‰";
      bigPY.textContent = "";
    }
  } else {
    bigZH.textContent = "ï¼ˆç‚¹å‡»â€œæ˜¾ç¤ºç­”æ¡ˆâ€ï¼‰";
    bigPY.textContent = "";
  }
}

// ------------------------------
// MCQ
// ------------------------------
function buildChoices(){
  const it = VIEW[quizIdx];
  if (!it) return;

  const key = it[2];
  const sp0 = splitZhPy(it[1]);

  const options = [{ key, zh: sp0.zh, py: sp0.py }];
  const pool = VIEW.filter(x => x[2] !== key);
  const need = Math.min(3, pool.length);
  const used = new Set([key]);

  while (options.length < 1 + need) {
    const pick = pool[Math.floor(Math.random() * pool.length)];
    const pKey = pick[2];
    if (used.has(pKey)) continue;
    used.add(pKey);
    const sp = splitZhPy(pick[1]);
    options.push({ key: pKey, zh: sp.zh, py: sp.py });
  }

  shuffle(options);
  currentChoices = { correctKey: key, options };
  answered = false;
  mcqHintEl.textContent = "ç‚¹å‡»é€‰é¡¹ä½œç­”ã€‚ç­”å®Œä¼šæ˜¾ç¤ºæ­£è¯¯ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚";
  renderChoicesUI();
}

function renderChoicesUI(){
  choicesEl.innerHTML = "";
  if (!quizMode || !mcqEnabled || !currentChoices) return;

  const letters = ["A","B","C","D"];

  for (let i = 0; i < currentChoices.options.length; i++) {
    const opt = currentChoices.options[i];
    const btn = document.createElement("button");
    btn.className = "btn choiceBtn";
    btn.textContent = letters[i] + ". " + opt.zh + (opt.py ? ("  (" + opt.py + ")") : "");

    if (answered && opt.key === currentChoices.correctKey) {
      btn.className = "btn primary choiceBtn";
    }

    btn.addEventListener("click", () => {
      if (answered) return;
      answered = true;

      const correctKey = currentChoices.correctKey;
      if (opt.key === correctKey) {
        mcqHintEl.textContent = "âœ… æ­£ç¡®ï¼";
      } else {
        mcqHintEl.textContent = "âŒ é”™äº†ï¼šå·²åŠ å…¥é”™é¢˜ã€‚";
        wrongMap[correctKey] = Number(wrongMap[correctKey] || 0) + 1;
        saveWrong();
      }

      renderQuizCard();
      renderChoicesUI();

      if (autoNext.checked) {
        setTimeout(async () => {
          next();
          if (quizMode) {
            if (mcqEnabled) buildChoices();
            await playThai();
          }
        }, 600);
      }
    });

    choicesEl.appendChild(btn);
  }
}

// ------------------------------
// Audio
// ------------------------------
async function safePlay(src){
  audio.loop = !!loopPlay.checked;
  audio.src = src;
  try {
    await audio.play();
    return true;
  } catch (e) {
    alert("æ— æ³•æ’­æ”¾éŸ³é¢‘ï¼š" + src + "æ‰‹æœºæµè§ˆå™¨é€šå¸¸éœ€è¦å…ˆæ‰‹åŠ¨ç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘æƒé™ã€‚" );
    return false;
  }
}

async function playThai(){
  const key = currentKey();
  if (!key) return;
  await safePlay(thAudioPath(key));
}

async function playChinese(){
  const key = currentKey();
  if (!key) return;
  await safePlay(zhAudioPath(key));
}

// ------------------------------
// Navigation
// ------------------------------
function next(){
  if (!VIEW.length) return;

  if (quizMode) {
    const pool = getQuizPool();
    const pos = pool.indexOf(quizIdx);
    quizIdx = pool[(pos + 1) % pool.length];
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  } else {
    activeIdx = (activeIdx + 1) % VIEW.length;
    renderList();
    renderStudyCard();
  }
}

function prev(){
  if (!VIEW.length) return;

  if (quizMode) {
    const pool = getQuizPool();
    const pos = pool.indexOf(quizIdx);
    quizIdx = pool[(pos - 1 + pool.length) % pool.length];
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  } else {
    activeIdx = (activeIdx - 1 + VIEW.length) % VIEW.length;
    renderList();
    renderStudyCard();
  }
}

function applyFilter(){
  const q = String(qEl.value || "").trim().toLowerCase();
  if (!q) VIEW = DATA.slice();
  else VIEW = DATA.filter(it =>
    String(it[0]).toLowerCase().includes(q) ||
    String(it[1]).toLowerCase().includes(q) ||
    String(it[2]).toLowerCase().includes(q)
  );

  activeIdx = 0;
  quizIdx = 0;
  answered = false;
  currentChoices = null;

  renderList();
  if (quizMode) {
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  } else {
    renderStudyCard();
  }
}

function markKnown(){
  const key = currentKey();
  if (!key) return;
  if (known.has(key)) known.delete(key);
  else known.add(key);
  saveKnown();
  renderList();
  updateProgress();
}

function resetKnown(){
  if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰â€˜å·²ç†Ÿæ‚‰â€™æ ‡è®°å—ï¼Ÿ")) return;
  known.clear();
  saveKnown();
  renderList();
  updateProgress();
}

function clearWrong(){
  if (!confirm("ç¡®å®šè¦æ¸…ç©ºé”™é¢˜è®°å½•å—ï¼Ÿ")) return;
  for (const k of Object.keys(wrongMap)) delete wrongMap[k];
  saveWrong();
  renderList();
  if (quizMode && mcqEnabled) buildChoices();
}

// ------------------------------
// Events
// ------------------------------
audio.addEventListener("ended", async () => {
  if (!autoNext.checked) return;
  next();
  if (quizMode) {
    if (mcqEnabled) buildChoices();
    await playThai();
  } else {
    await playChinese();
  }
});

el("clear").addEventListener("click", () => { qEl.value = ""; applyFilter(); });
qEl.addEventListener("input", applyFilter);

el("next").addEventListener("click", next);
el("prev").addEventListener("click", prev);

// Card navigation (mobile-friendly)
el("prevQ").addEventListener("click", async () => {
  prev();
  if (quizMode) await playThai();
  else await playChinese();
});

el("nextQ").addEventListener("click", async () => {
  next();
  if (quizMode) await playThai();
  else await playChinese();
});

el("shuffle").addEventListener("click", () => {
  // shuffle only in normal mode
  if (quizMode) return;
  VIEW = VIEW.slice().sort(() => Math.random() - 0.5);
  activeIdx = 0;
  renderList();
  renderStudyCard();
});

el("replay").addEventListener("click", async () => {
  if (quizMode) await playThai();
  else await playChinese();
});

el("quiz").addEventListener("click", async () => {
  quizMode = !quizMode;
  answered = false;
  currentChoices = null;
  quizIdx = activeIdx;

  updateModeUI();
  renderList();

  if (quizMode) {
    renderQuizCard();
    if (mcqEnabled) buildChoices();
    await playThai();
  } else {
    renderStudyCard();
  }
});

el("playTh").addEventListener("click", async () => {
  if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
  await playThai();
});

el("playZh").addEventListener("click", async () => {
  if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
  await playChinese();
});

el("showAns").addEventListener("click", () => {
  if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
  if (mcqEnabled) return alert("é€‰æ‹©é¢˜å·²å¼€å¯ï¼šè¯·ç›´æ¥ä½œç­”ï¼Œç­”å®Œä¼šæ˜¾ç¤ºç­”æ¡ˆã€‚å¦‚éœ€æ‰‹åŠ¨æ˜¾ç¤ºç­”æ¡ˆï¼Œè¯·å…ˆå…³é—­â€˜é€‰æ‹©é¢˜â€™ã€‚" );
  const it = VIEW[quizIdx];
  if (!it) return;
  const sp = splitZhPy(it[1]);
  bigZH.textContent = sp.zh || "â€”";
  bigPY.textContent = sp.py || "";
});

el("mcqMode").addEventListener("click", () => {
  if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
  mcqEnabled = !mcqEnabled;
  answered = false;
  currentChoices = null;
  updateModeUI();
  renderQuizCard();
  if (mcqEnabled) buildChoices();
});

el("mark").addEventListener("click", markKnown);
el("reset").addEventListener("click", resetKnown);

el("wrongOnlyBtn").addEventListener("click", () => {
  wrongOnly = !wrongOnly;
  el("wrongOnlyBtn").textContent = "åªç»ƒé”™é¢˜ï¼š" + (wrongOnly ? "å¼€" : "å…³");
  if (quizMode) {
    const pool = getQuizPool();
    quizIdx = pool[0] || 0;
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  }
});

el("clearWrong").addEventListener("click", clearWrong);

// ------------------------------
// Init
// ------------------------------
(async function init(){
  try {
    statusEl.textContent = "åŠ è½½ä¸­â€¦";
    DATA = await loadCSV();
    VIEW = DATA.slice();
    statusEl.textContent = "å·²åŠ è½½ï¼š" + DATA.length + "æ¡";

    updateModeUI();
    renderList();
    renderStudyCard();
    updateWrongStat();
    applyMobileTabs();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "é”™è¯¯ï¼šæ— æ³•åŠ è½½CSV";
    alert("æ— æ³•åŠ è½½CSVã€‚\n\n" + (e && e.message ? e.message : String(e)));
  }
})();

// Manual load CSV URL
el("loadCsvBtn").addEventListener("click", async () => {
  try {
    statusEl.textContent = "åŠ è½½ä¸­â€¦";
    const url = el("csvUrl").value || "";
    DATA = await loadCSV(url);
    VIEW = DATA.slice();
    activeIdx = 0; quizIdx = 0; answered = false; currentChoices = null;
    statusEl.textContent = "å·²åŠ è½½ï¼š" + DATA.length + "æ¡";
    updateModeUI();
    renderList();
    renderStudyCard();
    applyMobileTabs();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "é”™è¯¯ï¼šæ— æ³•åŠ è½½CSV";
    alert("åŠ è½½å¤±è´¥ï¼š\n" + (e && e.message ? e.message : String(e)));
  }
});

// Local file load
el("useFileBtn").addEventListener("click", async () => {
  const f = (el("csvFile") && el("csvFile").files && el("csvFile").files[0]) ? el("csvFile").files[0] : null;
  if (!f) return alert("è¯·é€‰æ‹©ä¸€ä¸ª CSV æ–‡ä»¶");
  try {
    statusEl.textContent = "è¯»å–æœ¬åœ°CSVâ€¦";
    const text = await f.text();
    let rows = parseCSV(text);

    const head = (rows[0] || []).map(x => (x || "").toLowerCase());
    const hasHeader = head.includes("thai") || head.includes("chinese_pinyin") || head.includes("tts_key");
    if (hasHeader) rows = rows.slice(1);

    const out = [];
    for (const r of rows) {
      const thai = (r[0] || "").trim();
      const zhpy = (r[1] || "").trim();
      const key  = (r[2] || "").trim();
      if (!thai || !zhpy || !key) continue;
      out.push([thai, zhpy, key]);
    }

    if (!out.length) throw new Error("CSV parsed but empty (check columns: Thai,Chinese_Pinyin,TTS_Key)");

    DATA = out;
    VIEW = DATA.slice();
    csvWhereEl.style.display = "inline-block";
    csvWhereEl.textContent = "CSVï¼šæœ¬åœ°æ–‡ä»¶ " + f.name;

    activeIdx = 0; quizIdx = 0; answered = false; currentChoices = null;
    statusEl.textContent = "å·²åŠ è½½ï¼š" + DATA.length + "æ¡";

    updateModeUI();
    renderList();
    renderStudyCard();
    applyMobileTabs();
  } catch (e) {
    console.error(e);
    statusEl.textContent = "é”™è¯¯ï¼šæ— æ³•åŠ è½½CSV";
    alert("æœ¬åœ°CSVè§£æå¤±è´¥ï¼š\n" + (e && e.message ? e.message : String(e)));
  }
});
</script>
</body>
</html>
