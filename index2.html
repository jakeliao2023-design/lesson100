<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a30; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --danger:#fb7185;
      --border:rgba(148,163,184,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai","Noto Sans",sans-serif;background:linear-gradient(180deg,#050915 0%,#0b1220 100%);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,18,32,.85);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:900px){.grid{grid-template-columns:380px 1fr}}

    @media(min-width:700px) and (max-width:899px){
      .wrap{padding:14px}
      .list{max-height:52vh}
    }

    @media(max-width:699px){
      .wrap{padding:12px}
      header .wrap{padding:12px}
      h1{font-size:16px}
      .pill{font-size:11px}
      .grid{gap:10px}
      .panel .hd{padding:10px}
      .panel .bd{padding:10px}
      .btn{padding:10px 12px;font-size:13px;border-radius:12px}
      .bigTH{font-size:20px}
      .bigZH{font-size:18px}
      .bigPY{font-size:14px}
      .list{max-height:none;height:calc(100dvh - 210px);}
      main.wrap{padding-bottom:76px}
      .mobile-nav{display:flex}
    }

    .mobile-nav{
      display:none;
      position:fixed;
      left:0;right:0;bottom:0;
      padding:10px 12px;
      background:rgba(11,18,32,.92);
      backdrop-filter:blur(10px);
      border-top:1px solid var(--border);
      z-index:60;
      gap:10px;
    }
    .seg{flex:1;display:flex;gap:8px}
    .seg button{flex:1}
    .seg .active{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}

    .panel{background:rgba(15,26,48,.7);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .panel .hd{padding:12px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .panel .bd{padding:12px}

    input[type="text"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#081022;color:var(--text);outline:none}
    input[type="text"]::placeholder{color:#64748b}

    .btn{cursor:pointer;border:1px solid var(--border);background:#0a1327;color:var(--text);padding:9px 12px;border-radius:10px;font-weight:600;font-size:13px}
    .btn:hover{border-color:rgba(148,163,184,.4)}
    .btn.primary{background:linear-gradient(90deg,#16a34a,#22c55e);border:none;color:#04110a}
    .btn.secondary{background:linear-gradient(90deg,#2563eb,#60a5fa);border:none;color:#071225}
    .btn.danger{background:linear-gradient(90deg,#e11d48,#fb7185);border:none;color:#18040a}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}

    .list{max-height:62vh;overflow:auto}
    .item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;gap:10px;align-items:flex-start}
    .item:hover{background:rgba(96,165,250,.08)}
    .item.active{background:rgba(34,197,94,.12)}
    .idx{color:var(--muted);font-variant-numeric:tabular-nums;min-width:38px}
    .th{font-size:15px;line-height:1.4}
    .zh{font-size:14px;color:#c7d2fe;margin-top:3px}

    .card{padding:14px;border-radius:14px;background:rgba(15,26,48,.7);border:1px solid var(--border)}
    .bigTH{font-size:22px;font-weight:800;letter-spacing:.2px}
    .bigZH{margin-top:10px;font-size:20px;font-weight:800}
    .bigPY{margin-top:6px;color:var(--accent2);font-size:15px}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;display:flex;gap:10px;flex-wrap:wrap}

    .progress{height:10px;background:#071022;border-radius:999px;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#16a34a,#22c55e);width:0%}

    .toggle{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .toggle input{transform:scale(1.1)}

    .note{color:var(--muted);font-size:12px;line-height:1.5}
    code{background:#071022;padding:2px 6px;border-radius:8px;border:1px solid var(--border)}
    .warn{color:#fbbf24}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(8,16,34,.6);color:var(--muted);font-size:12px}

    /* Choices */
    .choiceBtn{width:100%;text-align:left}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <h1>
        ä¸­æ–‡å¸¸ç”¨è¯­ 100 å¥ï½œç‚¹è¯»è¯¾ä»¶ï¼ˆCSVç‰ˆï¼‰
        <br/><span style="font-size:13px;color:#94a3b8">à¸šà¸—à¹€à¸£à¸µà¸¢à¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™ 100 à¸›à¸£à¸°à¹‚à¸¢à¸„ (à¸„à¸¥à¸´à¸à¹€à¸à¸·à¹ˆà¸­à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡)</span>
      </h1>
      <span class="pill">æ™®é€šï¼šç‚¹åˆ—è¡¨æ’­ä¸­æ–‡ï½œæµ‹éªŒï¼šé¢˜ç›®=æ³°è¯­+æ³°è¯­éŸ³é¢‘ï¼›ç­”æ¡ˆ=ä¸­æ–‡+æ‹¼éŸ³ï¼ˆå››é€‰ä¸€ï¼‰</span>
      <span class="pill" id="status">æœªåŠ è½½</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <!-- å·¦ä¾§ï¼šåˆ—è¡¨ -->
    <section class="panel" id="listPanel">
      <div class="hd">
        <input id="q" type="text" placeholder="æœç´¢ï¼šæ³°è¯­ / ä¸­æ–‡ / æ‹¼éŸ³ / key â€¦" />
        <button class="btn tight" id="clear">æ¸…ç©º</button>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:10px">
          <button class="btn" id="quiz">ğŸ§ å¬éŸ³é—®ç­”<br/>à¹à¸šà¸šà¸—à¸”à¸ªà¸­à¸šà¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</button>
          <button class="btn secondary" id="shuffle">éšæœº</button>
          <button class="btn" id="prev">ä¸Šä¸€æ¡</button>
          <button class="btn" id="next">ä¸‹ä¸€æ¡</button>
        </div>
        <div class="progress" title="å­¦ä¹ è¿›åº¦ï¼ˆå·²æ ‡è®°ç†Ÿæ‚‰ï¼‰"><div class="bar" id="bar"></div></div>
        <div class="meta" style="margin:10px 0 0">
          <span id="count">0 æ¡</span>
          <span id="knownCount">å·²ç†Ÿæ‚‰ 0</span>
          <span class="toggle"><input type="checkbox" id="auto" /> è‡ªåŠ¨ä¸‹ä¸€æ¡</span>
          <span class="toggle"><input type="checkbox" id="loop" /> å¾ªç¯æ’­æ”¾</span>
          <span class="badge" id="mode">æ™®é€šæ¨¡å¼</span>
        </div>
      </div>
      <div class="list" id="list"></div>
    </section>

    <!-- å³ä¾§ï¼šå¡ç‰‡ -->
    <section class="panel" id="cardPanel">
      <div class="hd">
        <button class="btn primary" id="playTh">â–¶ æ’­æ”¾æ³°è¯­<br/>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</button>
        <button class="btn" id="replay">âŸ² é‡æ’­</button>
        <button class="btn secondary" id="showAns">ğŸ‘ æ˜¾ç¤ºç­”æ¡ˆ<br/>à¸”à¸¹à¸„à¸³à¸•à¸­à¸š</button>
        <button class="btn secondary" id="mcqMode">ğŸ…°ğŸ…± é€‰æ‹©é¢˜<br/>à¸•à¸±à¸§à¹€à¸¥à¸·à¸­à¸</button>
        <button class="btn" id="playZh">â–¶ æ’­æ”¾ä¸­æ–‡<br/>à¹€à¸¥à¹ˆà¸™à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™</button>
        <button class="btn" id="mark">âœ“ æ ‡è®°ç†Ÿæ‚‰</button>
        <button class="btn danger" id="reset">é‡ç½®ç†Ÿæ‚‰</button>
      </div>
      <div class="bd">
        <div class="card">
          <div class="bigTH" id="bigTH">â€”</div>
          <div class="bigZH" id="bigZH">â€”</div>
          <div class="bigPY" id="bigPY">â€”</div>
          <div class="meta">
            <span>éŸ³é¢‘ keyï¼š<code id="key">â€”</code></span>
            <span>æ–‡ä»¶ï¼š<code id="file">â€”</code></span>
            <span>é”™é¢˜ï¼š<code id="wrongStat">0é¢˜/0æ¬¡</code></span>
          </div>
        </div>

        <div style="height:12px"></div>

        <!-- é€‰æ‹©é¢˜åŒºåŸŸï¼ˆä»…æµ‹éªŒæ¨¡å¼æ˜¾ç¤ºï¼‰ -->
        <div class="card" id="mcq" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div style="font-weight:800">é€‰æ‹©é¢˜ï¼ˆå››é€‰ä¸€ï¼‰<span style="font-weight:600;color:#94a3b8">ï½œà¸„à¸³à¸–à¸²à¸¡à¹à¸šà¸šà¹€à¸¥à¸·à¸­à¸à¸•à¸­à¸š</span></div>
            <div class="row" style="margin:0">
              <button class="btn tight" id="wrongOnlyBtn">åªç»ƒé”™é¢˜ï¼šå…³</button>
              <button class="btn danger tight" id="clearWrong">æ¸…ç©ºé”™é¢˜</button>
            </div>
          </div>
          <div style="height:10px"></div>
          <div id="choices" class="row" style="flex-direction:column;align-items:stretch"></div>
          <div style="height:10px"></div>
          <div class="note" id="mcqHint">ç‚¹å‡»é€‰é¡¹ä½œç­”ã€‚ç­”å®Œä¼šæ˜¾ç¤ºæ­£è¯¯ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚</div>
        </div>

        <div style="height:12px"></div>
        <div class="note">
          <b>æ–‡ä»¶ç»“æ„ï¼ˆåŒä¸€æ–‡ä»¶å¤¹ï¼‰:</b><br/>
          <code>index.html</code>ï¼ˆæœ¬æ–‡ä»¶ï¼‰<br/>
          <code>phrases.csv</code>ï¼ˆ3åˆ—ï¼šThai,Chinese_Pinyin,TTS_Keyï¼‰<br/>
          <code>audio/</code>ï¼ˆä¸­æ–‡éŸ³é¢‘ / à¹€à¸ªà¸µà¸¢à¸‡à¸ à¸²à¸©à¸²à¸ˆà¸µà¸™ï¼‰<code>&lt;key&gt;.mp3</code>ï¼ˆä¾‹å¦‚ <code>audio/zh_cn_0001.mp3</code>ï¼‰<br/>
          <code>audio_th/</code>ï¼ˆæ³°è¯­éŸ³é¢‘ / à¹€à¸ªà¸µà¸¢à¸‡à¸ à¸²à¸©à¸²à¹„à¸—à¸¢ï¼‰<code>th_0001.mp3</code>ï¼ˆä¾‹å¦‚ <code>audio_th/th_0001.mp3</code>ï¼‰<br/>
          <br/>
          <b class="warn">æ³¨æ„ï¼š</b>æ‰‹æœºæµè§ˆå™¨é€šå¸¸éœ€è¦å…ˆç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘æƒé™ã€‚
        </div>
      </div>
    </section>
  </div>

  <!-- Mobile bottom nav -->
  <div class="mobile-nav" id="mobileNav">
    <div class="seg">
      <button class="btn" id="tabList">ğŸ“‹ åˆ—è¡¨<br/>à¸£à¸²à¸¢à¸à¸²à¸£</button>
      <button class="btn active" id="tabPractice">ğŸ§ ç»ƒä¹ <br/>à¸à¸¶à¸</button>
    </div>
  </div>
</main>

<audio id="audio" preload="auto"></audio>

<script>
"use strict";

/* ------------------------------
   Mobile tabs (List / Practice)
------------------------------ */
function applyMobileTabs() {
  const isMobile = window.matchMedia("(max-width:699px)").matches;
  const listPanel = document.getElementById("listPanel");
  const cardPanel = document.getElementById("cardPanel");
  const nav = document.getElementById("mobileNav");
  if (!listPanel || !cardPanel || !nav) return;

  if (!isMobile) {
    nav.style.display = "none";
    listPanel.style.display = "";
    cardPanel.style.display = "";
    return;
  }

  nav.style.display = "flex";
  if (!window.__tab) window.__tab = "practice";
  listPanel.style.display = (window.__tab === "list") ? "" : "none";
  cardPanel.style.display = (window.__tab === "practice") ? "" : "none";

  const tabList = document.getElementById("tabList");
  const tabPractice = document.getElementById("tabPractice");
  if (tabList && tabPractice) {
    tabList.classList.toggle("active", window.__tab === "list");
    tabPractice.classList.toggle("active", window.__tab === "practice");
  }
}
function setTab(tab){ window.__tab = tab; applyMobileTabs(); }
window.addEventListener("resize", applyMobileTabs);
document.addEventListener("click", (e) => {
  const id = e.target && e.target.id ? e.target.id : "";
  if (id === "tabList") setTab("list");
  if (id === "tabPractice") setTab("practice");
});
document.addEventListener("DOMContentLoaded", applyMobileTabs);

/* ------------------------------
   Helpers
------------------------------ */
const el = (id) => document.getElementById(id);

function parseCSV(csv) {
  const lines = csv.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
  const rows = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const row = [];
    let cur = "";
    let inQ = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === ',' && !inQ) {
        row.push(cur); cur = "";
      } else {
        cur += ch;
      }
    }
    row.push(cur);
    rows.push(row.map(s => (s || "").trim()));
  }
  return rows;
}

async function loadCSV() {
  const res = await fetch("phrases.csv", { cache: "no-store" });
  if (!res.ok) throw new Error("phrases.csv not found");
  const text = await res.text();
  let rows = parseCSV(text);
  const head = (rows[0] || []).map(x => (x || "").toLowerCase());
  const hasHeader = head.includes("thai") || head.includes("chinese_pinyin") || head.includes("tts_key");
  if (hasHeader) rows = rows.slice(1);

  const out = [];
  for (const r of rows) {
    const thai = (r[0] || "").trim();
    const zhpy = (r[1] || "").trim();
    const key = (r[2] || "").trim();
    if (!thai || !zhpy || !key) continue;
    out.push([thai, zhpy, key]);
  }
  return out;
}

function splitZhPy(zhpy) {
  const m = zhpy.match(/^(.*?)(\s+[A-Za-zÄÃ¡ÇÃ Ä“Ã©Ä›Ã¨Ä«Ã­ÇÃ¬ÅÃ³Ç’Ã²Å«ÃºÇ”Ã¹Ç–Ç˜ÇšÇœ\s]+.*)$/);
  if (!m) return { zh: zhpy, py: "" };
  return { zh: m[1].trim(), py: m[2].trim() };
}

function zhAudioPath(key){ return `audio/${key}.mp3`; }
function thAudioPath(key){
  const m = key.match(/(\d+)$/);
  const num = m ? m[1].padStart(4, "0") : "0001";
  return "audio_th/th_" + num + ".mp3";
}

/* ------------------------------
   State
------------------------------ */
const listEl = el("list");
const qEl = el("q");
const statusEl = el("status");
const modeEl = el("mode");
const bigTH = el("bigTH");
const bigZH = el("bigZH");
const bigPY = el("bigPY");
const keyEl = el("key");
const fileEl = el("file");
const barEl = el("bar");
const countEl = el("count");
const knownCountEl = el("knownCount");
const wrongStatEl = el("wrongStat");

const audio = el("audio");
const autoNext = el("auto");
const loopPlay = el("loop");

const mcqCard = el("mcq");
const choicesEl = el("choices");
const mcqHintEl = el("mcqHint");

let DATA = [];       // åŸå§‹é¡ºåº
let FILTERED = [];   // æœç´¢åçš„æ•°æ®ï¼ˆä¿æŒåŸé¡ºåºï¼‰
let VIEW = [];       // å½“å‰åˆ—è¡¨å±•ç¤ºï¼ˆæ™®é€šæ¨¡å¼å¯éšæœºï¼‰
let activeIdx = 0;

let quizMode = false;
let quizIdx = 0;
let quizReveal = false;

// MCQ
let mcqEnabled = true;
let currentChoices = null;
let answered = false;

// Known / Wrong
const KNOWN_KEY = "lesson100_known_v1";
const WRONG_KEY = "lesson100_wrong_v1";
const known = new Set(JSON.parse(localStorage.getItem(KNOWN_KEY) || "[]"));
const wrongMap = JSON.parse(localStorage.getItem(WRONG_KEY) || "{}") || {};
let wrongOnly = false;

function saveKnown(){ localStorage.setItem(KNOWN_KEY, JSON.stringify([...known])); }
function saveWrong(){ localStorage.setItem(WRONG_KEY, JSON.stringify(wrongMap)); updateWrongStat(); }
function updateWrongStat(){
  const keys = Object.keys(wrongMap);
  const totalWrong = keys.reduce((a,k)=>a+(Number(wrongMap[k])||0), 0);
  wrongStatEl.textContent = `${keys.length}é¢˜/${totalWrong}æ¬¡`;
}

/* ------------------------------
   Rendering
------------------------------ */
function updateModeUI(){
  modeEl.textContent = quizMode ? "æµ‹éªŒæ¨¡å¼" : "æ™®é€šæ¨¡å¼";
  el("showAns").style.display = quizMode ? "inline-block" : "none";
  el("playZh").style.display  = quizMode ? "inline-block" : "none";
  el("playTh").style.display  = quizMode ? "inline-block" : "none";
  el("mcqMode").style.display = quizMode ? "inline-block" : "none";
  mcqCard.style.display = (quizMode && mcqEnabled) ? "block" : "none";
}

function updateProgress(){
  const total = FILTERED.length || 1;
  const knownCount = FILTERED.filter(([, , key]) => known.has(key)).length;
  knownCountEl.textContent = `å·²ç†Ÿæ‚‰ ${knownCount}`;
  barEl.style.width = `${Math.round((knownCount / total) * 100)}%`;
  updateWrongStat();
}

function renderList(){
  listEl.innerHTML = "";
  const source = quizMode ? FILTERED : VIEW;
  source.forEach((it, i) => {
    const [thai, zhpy, key] = it;
    const div = document.createElement("div");
    const isActive = quizMode ? (i === quizIdx) : (i === activeIdx);
    div.className = "item" + (isActive ? " active" : "");

    const idx = document.createElement("div");
    idx.className = "idx";
    idx.textContent = String(i + 1).padStart(3, "0");

    const body = document.createElement("div");
    const th = document.createElement("div");
    th.className = "th";
    const wrongTag = wrongMap[key] ? `  âœ—${wrongMap[key]}` : "";
    th.textContent = thai + (known.has(key) ? "  âœ“" : "") + wrongTag;

    const zh = document.createElement("div");
    zh.className = "zh";
    zh.textContent = zhpy;

    body.appendChild(th);
    body.appendChild(zh);
    div.appendChild(idx);
    div.appendChild(body);

    div.addEventListener("click", async () => {
      if (quizMode) {
        quizIdx = i;
        quizReveal = false;
        answered = false;
        currentChoices = null;
        renderList();
        renderQuizCard();
        if (mcqEnabled) buildChoices();
        await playThai();
      } else {
        activeIdx = i;
        renderList();
        renderStudyCard();
        await playChinese();
      }
    });

    listEl.appendChild(div);
  });

  countEl.textContent = `${(quizMode ? FILTERED : VIEW).length} æ¡`;
  updateProgress();
}

function renderStudyCard(){
  const src = VIEW.length ? VIEW : FILTERED;
  if (!src.length) return;
  const [thai, zhpy, key] = src[activeIdx] || src[0];
  const { zh, py } = splitZhPy(zhpy);
  bigTH.textContent = thai;
  bigZH.textContent = zh;
  bigPY.textContent = py;
  keyEl.textContent = key;
  fileEl.textContent = `ZH: ${zhAudioPath(key)}`;
}

function renderQuizCard(){
  if (!FILTERED.length) return;
  const [thai, zhpy, key] = FILTERED[quizIdx] || FILTERED[0];
  const { zh, py } = splitZhPy(zhpy);
  bigTH.textContent = `Q${String(quizIdx + 1).padStart(3,"0")}. ${thai}`;
  keyEl.textContent = key;
  fileEl.textContent = `TH: ${thAudioPath(key)} | ZH: ${zhAudioPath(key)}`;

  if (mcqEnabled) {
    // ç­”æ¡ˆé»˜è®¤éšè—ï¼Œç­”å®Œæ˜¾ç¤º
    if (answered) {
      bigZH.textContent = zh;
      bigPY.textContent = py;
    } else {
      bigZH.textContent = "ï¼ˆè¯·é€‰æ‹©æ­£ç¡®ä¸­æ–‡ + æ‹¼éŸ³ï¼‰";
      bigPY.textContent = "";
    }
  } else {
    if (quizReveal) {
      bigZH.textContent = zh;
      bigPY.textContent = py;
    } else {
      bigZH.textContent = "ï¼ˆç‚¹å‡»â€œæ˜¾ç¤ºç­”æ¡ˆâ€ï¼‰";
      bigPY.textContent = "";
    }
  }
}

/* ------------------------------
   MCQ
------------------------------ */
function shuffleInPlace(arr){
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function buildChoices(){
  const it = FILTERED[quizIdx];
  if (!it) return;

  const [, zhpy, key] = it;
  const { zh, py } = splitZhPy(zhpy);
  const options = [{ key, zh, py }];

  // pool from FILTERED (keeps within current filter), exclude correct
  const pool = FILTERED.filter(x => x[2] !== key);
  const need = Math.min(3, pool.length);
  const used = new Set([key]);

  while (options.length < 1 + need) {
    const pick = pool[Math.floor(Math.random() * pool.length)];
    const pKey = pick[2];
    if (used.has(pKey)) continue;
    used.add(pKey);
    const p = splitZhPy(pick[1]);
    options.push({ key: pKey, zh: p.zh, py: p.py });
  }

  shuffleInPlace(options);
  currentChoices = { correctKey: key, options };
  answered = false;
  renderChoicesUI();
}

function renderChoicesUI(){
  choicesEl.innerHTML = "";
  if (!quizMode || !mcqEnabled || !currentChoices) return;

  const letters = ["A","B","C","D"];
  currentChoices.options.forEach((opt, idx) => {
    const btn = document.createElement("button");
    btn.className = "btn choiceBtn";
    btn.textContent = `${letters[idx]}. ${opt.zh}  (${opt.py})`;

    if (answered && opt.key === currentChoices.correctKey) {
      btn.className = "btn primary choiceBtn";
    }

    btn.addEventListener("click", async () => {
      if (answered) return;
      answered = true;

      const correctKey = currentChoices.correctKey;
      if (opt.key === correctKey) {
        mcqHintEl.textContent = "âœ… æ­£ç¡®ï¼å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬ä¸€éã€‚";
      } else {
        mcqHintEl.textContent = "âŒ é”™äº†ã€‚å·²åŠ å…¥é”™é¢˜æœ¬ï¼›å¯ç‚¹â€œæ’­æ”¾ä¸­æ–‡â€å¬æ­£ç¡®ç­”æ¡ˆã€‚";
        wrongMap[correctKey] = (Number(wrongMap[correctKey]) || 0) + 1;
        saveWrong();
      }

      renderQuizCard();
      renderChoicesUI();

      if (autoNext.checked) {
        setTimeout(async () => {
          next();
          if (quizMode) {
            if (mcqEnabled) buildChoices();
            await playThai();
          }
        }, 600);
      }
    });

    choicesEl.appendChild(btn);
  });
}

function getQuizPool(){
  if (!wrongOnly) return FILTERED.map((_, i) => i);
  const keys = new Set(Object.keys(wrongMap));
  const idxs = [];
  for (let i = 0; i < FILTERED.length; i++) {
    if (keys.has(FILTERED[i][2])) idxs.push(i);
  }
  return idxs.length ? idxs : FILTERED.map((_, i) => i);
}

/* ------------------------------
   Audio
------------------------------ */
async function safePlay(src){
  audio.loop = loopPlay.checked;
  audio.src = src;
  try{
    await audio.play();
    return true;
  }catch(e){
    alert(
      "æ— æ³•æ’­æ”¾éŸ³é¢‘ã€‚è¯·ç¡®è®¤ï¼š\n" +
      "1) phrases.csv ä¸ index.html åŒç›®å½•\n" +
      "2) ä¸­æ–‡éŸ³é¢‘ï¼šaudio/<key>.mp3 å­˜åœ¨ï¼ˆä¾‹å¦‚ audio/zh_cn_0001.mp3ï¼‰\n" +
      "3) æ³°è¯­éŸ³é¢‘ï¼šaudio_th/th_0001.mp3 å­˜åœ¨\n" +
      "4) æ‰‹æœºæµè§ˆå™¨éœ€è¦å…ˆæ‰‹åŠ¨ç‚¹ä¸€æ¬¡æ’­æ”¾æŒ‰é’®è§£é”éŸ³é¢‘æƒé™\n"
    );
    return false;
  }
}
function currentKey(){
  if (quizMode) return (FILTERED[quizIdx] || [])[2] || "";
  return (VIEW[activeIdx] || [])[2] || "";
}
async function playThai(){
  const key = currentKey(); if (!key) return;
  await safePlay(thAudioPath(key));
}
async function playChinese(){
  const key = currentKey(); if (!key) return;
  await safePlay(zhAudioPath(key));
}

/* ------------------------------
   Navigation
------------------------------ */
function next(){
  if (quizMode) {
    const pool = getQuizPool();
    const pos = pool.indexOf(quizIdx);
    quizIdx = pool[(pos + 1) % pool.length];
    quizReveal = false;
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  } else {
    if (!VIEW.length) return;
    activeIdx = (activeIdx + 1) % VIEW.length;
    renderList();
    renderStudyCard();
  }
}
function prev(){
  if (quizMode) {
    const pool = getQuizPool();
    const pos = pool.indexOf(quizIdx);
    quizIdx = pool[(pos - 1 + pool.length) % pool.length];
    quizReveal = false;
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  } else {
    if (!VIEW.length) return;
    activeIdx = (activeIdx - 1 + VIEW.length) % VIEW.length;
    renderList();
    renderStudyCard();
  }
}

function applyFilter(){
  const q = (qEl.value || "").trim().toLowerCase();
  if (!q) FILTERED = DATA.slice();
  else FILTERED = DATA.filter(([thai, zhpy, key]) =>
    thai.toLowerCase().includes(q) ||
    zhpy.toLowerCase().includes(q) ||
    key.toLowerCase().includes(q)
  );

  // æ™®é€šæ¨¡å¼ï¼šåˆ—è¡¨å¯éšæœºæ˜¾ç¤ºï¼ˆVIEWï¼‰ï¼Œæµ‹éªŒæ¨¡å¼ï¼šä¸¥æ ¼ FILTERED é¡ºåº
  VIEW = FILTERED.slice();

  activeIdx = 0;
  quizIdx = 0;
  quizReveal = false;
  answered = false;
  currentChoices = null;

  renderList();
  quizMode ? renderQuizCard() : renderStudyCard();
  if (quizMode && mcqEnabled) buildChoices();
}

function shuffleView(){
  if (quizMode) return; // æµ‹éªŒä¸¥æ ¼é¡ºåº
  VIEW = VIEW.slice().sort(() => Math.random() - 0.5);
  activeIdx = 0;
  renderList();
  renderStudyCard();
}

function markKnown(){
  const key = currentKey();
  if (!key) return;
  if (known.has(key)) known.delete(key); else known.add(key);
  saveKnown();
  renderList();
  updateProgress();
}
function resetKnown(){
  if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰â€œå·²ç†Ÿæ‚‰â€æ ‡è®°å—ï¼Ÿ")) return;
  known.clear();
  saveKnown();
  renderList();
  updateProgress();
}

function clearWrong(){
  if (!confirm("ç¡®å®šè¦æ¸…ç©ºé”™é¢˜è®°å½•å—ï¼Ÿ")) return;
  for (const k of Object.keys(wrongMap)) delete wrongMap[k];
  saveWrong();
  renderList();
  if (quizMode && mcqEnabled) { buildChoices(); renderQuizCard(); }
}

/* ------------------------------
   Events
------------------------------ */
audio.addEventListener("ended", async () => {
  if (!autoNext.checked) return;
  next();
  if (quizMode) {
    await playThai();
  } else {
    await playChinese();
  }
});

el("clear").addEventListener("click", () => { qEl.value=""; applyFilter(); });
qEl.addEventListener("input", applyFilter);

el("next").addEventListener("click", next);
el("prev").addEventListener("click", prev);
el("shuffle").addEventListener("click", shuffleView);

el("replay").addEventListener("click", async () => {
  if (quizMode) await playThai();
  else await playChinese();
});
el("playTh").addEventListener("click", async () => {
  if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
  await playThai();
});
el("playZh").addEventListener("click", async () => {
  if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
  await playChinese();
});

el("showAns").addEventListener("click", () => {
  if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
  if (mcqEnabled) return alert("é€‰æ‹©é¢˜æ¨¡å¼ä¸‹ï¼šè¯·ç›´æ¥ä½œç­”ï¼Œç­”å®Œä¼šæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆã€‚");
  quizReveal = true;
  renderQuizCard();
});

el("mcqMode").addEventListener("click", () => {
  if (!quizMode) return alert("è¯·å…ˆè¿›å…¥æµ‹éªŒæ¨¡å¼ï¼ˆç‚¹å‡»ï¼šå¬éŸ³é—®ç­”ï¼‰");
  mcqEnabled = !mcqEnabled;
  quizReveal = false;
  answered = false;
  currentChoices = null;
  updateModeUI();
  renderQuizCard();
  if (quizMode && mcqEnabled) buildChoices();
});

el("quiz").addEventListener("click", async () => {
  quizMode = !quizMode;
  quizReveal = false;
  answered = false;
  currentChoices = null;

  // ä»å½“å‰å­¦ä¹ ä½ç½®å¼€å§‹ï¼ˆæ˜ å°„åˆ° FILTERED å†…ç´¢å¼•ï¼‰
  const curKey = (VIEW[activeIdx] || [])[2];
  const startIdx = FILTERED.findIndex(x => x[2] === curKey);
  quizIdx = startIdx >= 0 ? startIdx : 0;

  updateModeUI();
  renderList();

  if (quizMode) {
    // è¿›å…¥æµ‹éªŒï¼šé»˜è®¤æ˜¾ç¤ºå››é€‰ä¸€
    if (mcqEnabled) mcqCard.style.display = "block";
    renderQuizCard();
    if (mcqEnabled) buildChoices();
    await playThai();
  } else {
    renderStudyCard();
  }
});

el("mark").addEventListener("click", markKnown);
el("reset").addEventListener("click", resetKnown);

el("wrongOnlyBtn").addEventListener("click", () => {
  wrongOnly = !wrongOnly;
  el("wrongOnlyBtn").textContent = `åªç»ƒé”™é¢˜ï¼š${wrongOnly ? "å¼€" : "å…³"}`;
  if (quizMode) {
    const pool = getQuizPool();
    quizIdx = pool[0] || 0;
    answered = false;
    currentChoices = null;
    renderList();
    renderQuizCard();
    if (mcqEnabled) buildChoices();
  }
});

el("clearWrong").addEventListener("click", clearWrong);

/* ------------------------------
   Tests
------------------------------ */
function assert(cond, msg){ if(!cond) throw new Error("Test failed: " + msg); }
function runTests(){
  const sample = "Thai,Chinese_Pinyin,TTS_Key\nà¸ªà¸§à¸±à¸ªà¸”à¸µ,ä½ å¥½ nÇ hÇo,zh_cn_0001\n";
  const rows = parseCSV(sample);
  assert(rows.length === 2, "parseCSV rows");
  const s = splitZhPy("ä½ å¥½ nÇ hÇo");
  assert(s.zh === "ä½ å¥½", "split zh");
  assert(s.py.includes("nÇ"), "split py");
  assert(thAudioPath("zh_cn_12") === "audio_th/th_0012.mp3", "thAudioPath pad");
}

/* ------------------------------
   Init
------------------------------ */
(async function init(){
  try{
    runTests();
    statusEl.textContent = "åŠ è½½ä¸­â€¦";
    DATA = await loadCSV();
    if (!DATA.length) throw new Error("CSV empty");
    FILTERED = DATA.slice();
    VIEW = FILTERED.slice();
    statusEl.textContent = `å·²åŠ è½½ï¼šphrases.csvï¼ˆ${DATA.length}æ¡ï¼‰`;

    updateModeUI();
    renderList();
    renderStudyCard();
    updateWrongStat();
    applyMobileTabs();
  }catch(e){
    console.error(e);
    statusEl.textContent = "é”™è¯¯ï¼šæ— æ³•åŠ è½½";
    alert("åˆå§‹åŒ–å¤±è´¥ï¼š " + (e && e.message ? e.message : String(e)));
  }
})();
</script>
</body>
</html>
